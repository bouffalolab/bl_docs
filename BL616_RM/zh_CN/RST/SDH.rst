===========
SDH
===========

简介
=====
SD主机控制器（SD Host Controller，即SDH）用于控制与SDIO或SD卡的通信，所有访问都通过标准的控制寄存器进行设置。

主要特征
=========
 - 符合SD协会定义的SD主机控制器规范
 - 适用于SDIO/SD存储卡
 - 支持SD主机控制器标准寄存器设置
 - 支持针对高速数据传输的DMA操作
 - 支持中断
 - 支持数据块传输

功能描述
===========
SDH总体结构
---------------

.. figure:: ../../picture/SDHArch.svg
   :align: center

   SDH硬件和驱动结构图

寄存器映射
--------------

.. figure:: ../../picture/SDHMap.svg
   :align: center

   标准寄存器映射分类图

其中：

 - SD Command Generation：用于生成SD命令的参数；
 - Response：来自卡的响应值；
 - Buffer Data Port：内部缓冲区的数据访问端口；
 - Host Control 1 and Others：当前状态、SD总线控制、主机复位等；
 - Interrupt Controls：中断状态和启用；
 - Host Control 2：供应商特定的主机控制器支持信息；
 - Capabilities：主机控制寄存器的扩展；
 - Force Event：通过软件生成事件的测试寄存器；
 - ADMA：高级DMA寄存器；
 - Preset Value：时钟频率选择和驱动强度选择预设；
 - Shared Bus：共享总线系统的设备控制；
 - Common Area：公共信息区。

多卡槽支持
--------------
为每个卡槽定义一个标准寄存器集，如果主机控制器有两个卡槽，则需要两个寄存器集。每个卡槽都是独立控制的。
这使得支持总线接口电压、总线定时和SD时钟频率的组合成为可能。

.. figure:: ../../picture/SDHSlot.svg
   :align: center

   多卡槽控制器的寄存器映射

上图显示了多卡槽主机控制器的寄存器映射。主机驱动程序应使用PCI配置寄存器或供应商特定方法确定卡槽数量和指向每个卡槽标准寄存器集的基指针。
从0F0h到0FFh的偏移量保留给公共寄存器区域，该区域定义卡槽控制和公共状态的信息。公共寄存器区域可从任何卡槽的寄存器集访问。
这允许软件独立控制每个卡槽，因为它可以从每个寄存器集中访问卡槽中断状态寄存器和主机控制器版本寄存器。

支持DMA
-----------
主机控制器为主机驱动程序提供“编程I/O”方法，以便使用缓冲区数据端口寄存器传输数据。可选地，主机控制器实现者可以支持使用DMA的数据传输。
在使用DMA之前，主机驱动程序应确认主机控制器和系统总线均支持DMA（PCI总线可支持DMA）。DMA应支持单块和多块传输。
在DMA传输执行期间，主机控制器寄存器应保持可访问性，以发出非DAT行命令。无论采用何种系统总线数据传输方法，DMA传输的结果应相同。
主机驱动程序可以通过块间隙控制寄存器中的控制位停止和重新启动DMA操作。通过设置在块间隙请求时停止，DMA操作可以在块间隙处停止。
通过设置继续请求，可以重新启动DMA操作。如果发生错误，DMA操作应停止。要中止DMA传输，主机驱动程序应通过软件重置寄存器中DAT行的软件重置来重置主机控制器，并在执行多块读/写命令时发出CMD12。

SD命令生成
--------------

.. figure:: ../../picture/SDHCMDGeneration.svg
   :align: center

   用于生成SD命令的寄存器

上表显示了三种类型的事务所需的寄存器设置（寄存器集中从000h到00Fh的偏移量）：DMA生成的传输（SDMA或ADMA）、CPU数据传输（使用“编程I/O”）和非DAT传输。
启动事务时，主机驱动程序应按从000h到00Fh的顺序对这些寄存器进行编程。起始寄存器偏移量可根据事务类型计算。最后写入的偏移量应始终为00Fh，因为写入命令寄存器的高位字节将触发SD命令的发出。
在一个数据事务期间，主机驱动程序不应读取SDMA系统地址、块大小和块计数寄存器，除非由于值正在更改且不稳定而停止或挂起传输。
为了防止在发出命令时使用数据传输破坏寄存器，块大小、块计数和传输模式寄存器应由主机控制器进行写保护，同时在当前状态寄存器中将命令禁止（DAT）设置为1（此信号无法保护SDMA系统地址）。
当命令禁止（CMD）设置为1时，主机驱动程序不得写入参数1和命令寄存器。

挂起和恢复机制
------------------
通过检查功能寄存器中的挂起/恢复支持，可以确定对挂起/恢复的支持。当SD卡接受挂起请求时，主机驱动程序在发出其他SD命令之前将信息保存在前14字节寄存器（即偏移量000h-00dh）中。
恢复时，主机驱动程序将恢复这些寄存器，然后发出Resume命令以继续挂起的操作。
SDIO卡在响应恢复命令时设置DF（恢复数据标志）。（由于挂起和恢复命令是CMD52操作，因此响应数据实际上是CCCR中的功能选择寄存器。）
如果DF设置为0，则表示SDIO卡在挂起时无法继续数据传输。该位可用于控制数据传输和中断周期。如果Resume Data（恢复数据）标志设置为0，则如果正在恢复的事务处于4位模式，则不再传输更多数据，并启动中断周期。
如果DF设置为1，则数据传输将继续。需要注意的是，要使用挂起和恢复功能，SDIO卡必须支持挂起和恢复命令以及读取等待控制。

.. figure:: ../../picture/SDHSuspend.svg
   :align: center

   挂起和恢复机制

缓冲区控制
--------------
主机控制器具有用于数据传输的数据缓冲区。主机驱动程序通过32位缓冲区数据端口寄存器访问内部缓冲区。下面是一些访问缓冲区的规则。

缓冲区指针的控制
*********************
在内部，主机控制器维护一个指针来控制数据缓冲区。主机驱动程序无法直接访问指针，每次访问缓冲区数据端口寄存器时，指针都会根据写入缓冲区的数据量递增。
为了适应各种系统总线，无论系统总线宽度如何，都应实现该指针（可支持8位、16位、32位或64位系统总线宽度）。

确定缓冲块长度
*******************
为了能够在突发时传输数据块，主机控制器和SD卡缓冲区大小之间的关系非常重要。主机驱动器应为主机控制器和卡使用相同的数据块长度。
如果控制器和卡缓冲区大小不同，主机驱动程序应使用较小的值。最大主机控制器缓冲区大小由功能寄存器中的最大块长度字段定义。

分割大数据传输
*******************
SDIO命令CMD53定义根据以下公式限制数据传输的最大数据大小：
最大数据大小 = 块大小 x 块计数
例如，块大小由缓冲区大小指定，块计数的最大值为512（9位计数），如CMD53的命令参数中所指定。
在最坏的情况下，如果卡只有一个1字节的缓冲区，则最多可以使用CMD53传输512字节的数据（块大小=1，块计数=512）。
如果卡不支持多块模式，在这种情况下只能传输一个字节。如果应用程序或卡驱动程序希望传输更大尺寸的数据，主机驱动程序应将大数据划分为多个CMD53块。

中断控制寄存器之间的关系
-----------------------------
主机控制器实现许多中断源。中断源可以作为中断或系统唤醒信号启用。如果正常中断状态启用或错误中断状态启用寄存器中的中断源对应位为1，且中断变为激活状态，则其激活状态被锁定，并可供正常中断状态寄存器或错误中断状态寄存器中的主机驱动程序使用。
当中断状态启用被清除时，中断状态应被清除。如果在正常中断信号启用寄存器或错误中断信号启用寄存器中也设置了相应位，则在中断状态寄存器中设置位的中断源应断言系统中断信号。
一旦发出信号，大多数中断将通过向中断状态寄存器中的相关位写入1来清除。但是，卡中断应由卡驱动程序清除。如果生成卡中断，主机驱动程序可以清除卡中断状态启用，以在卡驱动程序处理卡中断时禁用卡中断。
清除所有中断源后，主机驱动程序再次将其设置为启用另一个卡中断。禁用卡中断状态启用可避免在处理中断服务期间产生多个中断。
唤醒控制寄存器允许对卡中断、卡插入或卡移除状态更改进行配置，以生成系统唤醒信号。这些中断的启用或屏蔽独立于正常中断信号启用寄存器。可从正常中断状态寄存器读取唤醒事件的类型。
中断信号和唤醒信号为逻辑或，应从插槽中断状态寄存器中读取。

硬件框图和定时部分
-----------------------

.. figure:: ../../picture/SDHDiagram.svg
   :align: center

   主机控制器框图

主机控制器有两个总线接口，系统总线接口和SD总线接口。主机控制器假定这些接口是异步的（即，在不同的时钟频率下工作）。主机驱动程序处于系统总线时间（因为它是由主机控制器CPU在其系统时钟上执行的软件）。
SD卡在SD总线时间上（也就是说，其操作由SDCLK同步）。主机控制器应同步信号，以便在这些接口之间进行通信。数据块应在缓冲模块上同步。所有状态寄存器应通过系统时钟同步，并在输出至系统接口期间保持同步。
触发SD总线事务的控制寄存器应由SDCLK同步。因此，在两个接口之间传播信号时将存在定时延迟。这意味着主机驱动程序无法实时控制SD总线，需要依靠主机控制器根据寄存器设置控制SD总线。
缓冲区接口启用内部读写缓冲区。传输完成中断状态指示DMA和非DMA传输的读/写传输完成。但是，读和写之间的计时是不同的。读取传输应在所有有效数据传输到主机系统并准备好供主机驱动程序访问后完成。
写入传输应在所有有效数据传输到SD卡且忙碌状态结束后完成。

自动CMD12
-------------
SD内存的多个块传输需要CMD12停止事务。最后一次数据块传输完成时，主机控制器自动发出CMD12。主机控制器的此功能称为自动CMD12。发出多块传输命令时，主机驱动程序应在传输模式寄存器中设置Auto CMD12 Enable（自动CMD12启用）。
应通过主机控制器中的硬件完成与最后一个数据块的自动CMD12定时同步。在多次块传输期间，可以发出不使用DAT行的命令。这些命令使用CMD_wo_DAT符号表示。为了防止DAT线路命令和CMD_wo_DAT命令发生冲突，主机控制器应仲裁在SD总线上发出每个命令的时间。
因此，在主机驱动程序写入命令寄存器后，可能不会立即发出命令。该命令可以在自动CMD12之前或之后发出，具体取决于时间。为了能够区分DAT line和CMD_wo_DAT命令的响应，可以从响应寄存器的前四个字节（在标准寄存器集中的偏移量01Ch处）确定自动CMD12响应。
如果检测到与自动CMD12相关的错误，主机控制器应发出自动CMD错误中断。主机驱动程序可以通过读取自动CMD错误状态寄存器来检查自动CMD12错误状态（命令索引/结束位/CRC/超时错误）。如果未执行自动CMD12，则主机驱动程序需要从CMD_wo_DAT错误中恢复，并发出CMD12以停止多块传输。
如果未执行CMD_wo_DAT，则主机驱动程序可以在从自动CMD12错误恢复后再次发出该命令。
在UHS模式SDR104中，主机驱动程序应使用自动CMD23停止多块读/写操作，而不是使用自动CMD12。在其他总线速度模式下，如果卡支持CMD23，则主机驱动程序应使用自动CMD23，而不是使用CMD12。

控制SDCLK
-------------
下表显示了SDCLK如何由电源控制寄存器中的SD总线电源和时钟控制寄存器中的SD时钟启用控制：

.. figure:: ../../picture/SDHSDCLK.svg
   :align: center

   通过SD总线电源和SD时钟启用控制SDCLK

SDCLK的时钟周期由时钟控制寄存器中的SDCLK频率选择和功能寄存器中的SD时钟的基本时钟频率指定。由于SD卡可以同时使用两个时钟边缘，因此SD时钟的占空比应为平均50%（分散在45-55%范围内），高电平周期应为时钟周期的一半。
SDCLK的振荡从驱动规定的高电压周期开始。当SDCLK被SD时钟启用停止时，主机控制器应在高驱动周期后停止SDCLK，以维持时钟占空比。当SDCLK被SD总线电源停止时，主机控制器应立即停止SDCLK（驱动器低），并且应清除SD时钟启用。

高级DMA
------------
SD主机控制器标准规范2.00版定义了ADMA（高级DMA）传输算法。SD主机控制器标准规范1.00版中定义的DMA算法称为SDMA（单操作DMA）。SDMA的缺点是，在每个页面边界产生的DMA中断会干扰CPU重新编程新的系统地址。这种SDMA算法通过在每个页面边界处中断而形成性能瓶颈。
ADMA采用分散-聚集DMA算法，因此具有更高的数据传输速度。在执行ADMA之前，主机驱动程序可以将系统内存和SD卡之间的数据传输列表编程到描述符表中。它使ADMA能够在不中断主机驱动程序的情况下运行。
此外，ADMA不仅可以支持32位系统内存寻址，还可以支持64位系统内存寻址。32位系统内存寻址使用64位地址寄存器的低32位字段。
ADMA有两种类型；ADMA1和ADMA2。ADMA1仅支持系统内存中4KB对齐数据的数据传输。ADMA2改进了该限制，使任何位置和大小的数据都可以在系统内存中传输。描述符表的格式在它们之间是不同的。本文档中使用术语“ADMA”时，指ADMA2。

ADMA2的框图
***************

.. figure:: ../../picture/SDHADMADiagram.svg
   :align: center

   ADMA2的框图

描述符表由主机驱动程序在系统内存中创建。32位地址描述符表用于32位寻址的系统，64位地址描述符表用于64位寻址的系统。每个描述符行（一个可执行单元）由地址、长度和属性字段组成。该属性指定描述符行的操作。
ADMA2包括SDMA、状态机和寄存器电路。ADMA2不使用32位SDMA系统地址寄存器（偏移量0），但使用64位高级DMA系统地址寄存器（偏移量058h）作为描述符指针。写入命令寄存器会触发关闭ADMA2传输。ADMA2获取一个描述符行并执行它。重复此过程，直到找到描述符的末尾（属性中的end=1）。

数据地址和数据长度要求
***************************
对描述符进行编程有3个要求:

 - 地址的最小单位为4字节;
 - 每个描述符行的最大数据长度小于64KB;
 - 总长度 = 长度1 + 长度2 + 长度3 + … + 长度n = 块大小的倍数。

若描述符的总长度不是块大小的倍数，则可能不会终止ADMA2传输。在这种情况下，应通过数据超时中止传输。
块计数寄存器限制最大65535块传输。如果ADMA2操作小于或等于65535块传输，则可以使用块计数寄存器。在这种情况下，描述符表的总长度应等于乘以块大小和块计数。
如果ADMA2操作超过65535块传输，则应通过在传输模式寄存器中将0设置为块计数启用来禁用块计数寄存器。在这种情况下，数据传输的长度不是由块计数指定的，而是由描述符表指定的。
因此，检测SD总线上最后一个块的定时可能不同，并且它影响当前状态寄存器中的读传输活动、写传输活动和DAT线活动的控制。在读取操作的情况下，可能会读取多个块。如果读取操作是针对最后一块内存区域，则主机驱动程序应忽略超出范围的错误。

描述符表
*************

.. figure:: ../../picture/SDHADMADescriptor.svg
   :align: center

   32位地址描述符表

上图显示了32位地址描述符表的定义。一个描述符行消耗64位（8字节）内存空间。属性用于控制描述符。指定了3个动作符号：“Nop”操作跳过当前描述符行并获取下一行；“Tran”操作传输由地址和长度字段指定的数据；“Link”操作用于连接分开的两个描述符。链接的地址字段指向下一个描述符表。
Act2=0和Act1=1的组合被保留并定义为与Nop相同的操作。控制器的未来版本可能会使用此字段并重新定义新操作。32位地址存储在64位地址寄存器的低32位中。对于32位地址描述符表，地址字段应设置在32位边界上（低2位始终设置为0）。

ADMA2状态
*************
下图是ADMA2的状态图，定义了4个状态，获取描述符状态、更改地址状态、传输数据状态和停止ADMA状态：

.. figure:: ../../picture/SDHADMAState.svg
   :align: center

   ADMA2的状态图

其中：

 - ST_FDS（获取描述符）：ADMA2获取描述符行并在内部寄存器中设置参数，接下来转到ST_CADR状态；
 - ST_CADR（更改地址）：链接操作将另一个描述符地址加载到ADMA系统地址寄存器。在其他操作中，ADMA系统地址寄存器递增到下一个描述符行。如果End=0，则转到ST_TFR状态。即使出现一些错误，ADMA2也不得在此状态下停止；
 - ST_TFR（传输数据）：在系统内存和SD卡之间执行一条描述符行的数据传输。如果数据传输继续（End=0），则转到ST_FDS状态。如果数据传输完成，则转到ST_STOP状态；
 - ST_STOP（停止DMA）：在以下情况下，ADMA2将保持此状态，一是上电复位或软件复位后，一是所有描述符数据传输都已完成。如果通过写入命令寄存器启动新的ADMA2操作，转至ST_FDS状态。

ADMA2不支持挂起/恢复功能，但可以使用停止和继续。当在ADMA2操作期间设置块间隙控制寄存器中的块间隙停止请求时，当ADMA2在块间隙停止时，将生成块间隙事件中断。主机控制器应使用读取等待或停止SD时钟停止ADMA2读取操作。
停止ADMA2时，无法发出任何SD命令。ADMA2传输期间发生错误可能会停止ADMA2操作并生成ADMA错误中断。ADMA错误状态寄存器中的ADMA错误状态字段保存ADMA2已停止的状态。
主机驱动程序可以通过以下方法识别错误描述符位置：如果ADMA在ST_FDS状态下停止，则ADMA系统地址寄存器将指向错误描述符行。如果ADMA在ST_TFR或ST_STOP状态下停止，ADMA系统地址寄存器将指向错误描述符行的下一个位置。因此，ADMA2不得在ST_CADR状态停止。

测试寄存器
--------------
测试寄存器是为测试目的而定义的。当很难有意生成某些中断时，可以使用此功能手动生成这些中断以进行驱动程序调试。为此，定义了用于控制错误中断状态和自动CMD错误状态的强制事件寄存器。
有意控制插卡和拔卡也很困难，主机控制1寄存器中的卡检测信号选择和卡检测测试级别使能够人为控制当前状态寄存器所插入的卡，并在正常中断状态寄存器中生成卡插入和卡移除中断。

块计数
-----------
块计数命令（CMD23）提供了停止多块操作的无计时方法。在CMD23的参数中设置块计数，以指定其后的CMD18或CMD25的传输长度。自动CMD23是在发送CMD18或CMD25之前自动发出CMD23的功能。此功能的目的是通过删除CMD23的中断服务，避免在内存访问期间性能下降。
偏移量008h参数1寄存器用于CMD18或CMD25。然后为CMD23的参数2寄存器分配偏移量000h。主机控制器不使用参数2寄存器计算数据传输长度。主机端数据传输操作的数据长度有两种情况；非ADMA和ADMA。
AMDA描述符的总长度是指ADMA描述符每行的16位数据长度之和。应为ADMA禁用块计数启用。需要注意的是，主机控制器的总数据传输长度应等于卡的传输长度。

采样时钟调谐
----------------
在UHS-I模式下，SD总线可以在高时钟频率模式下运行，然后CMD和DAT[3:0]线路上的卡的数据窗口变小。数据窗口的位置将根据卡和主机系统的实施情况而变化。因此，当通过执行调谐程序并调整采样时钟来支持SDR104或SDR50（如果在能力寄存器中将SDR50的使用调谐设置为1）时，主机控制器应支持调谐电路。
主机控制2寄存器中的执行调谐和采样时钟选择用于控制调谐电路。

SD主机标准寄存器
--------------------

SD主机控制寄存器映射
*************************
下表总结了标准SD主机控制器寄存器集。主机驱动程序需要确定由主机系统特定方法设置的寄存器的基址。寄存器集的大小为256字节。对于多个卡槽控制器，每个卡槽分配一个寄存器集，但偏移量0F0h-0FFh处的寄存器分配为公共区域，这些寄存器包含每个卡槽寄存器集的相同值。

.. figure:: ../../picture/SDHRegisterMap.svg
   :align: center

   SD主机控制寄存器映射

配置寄存器类型
*******************
配置寄存器字段被分配下表描述的一个属性：

.. figure:: ../../picture/SDHRegisterType.svg
   :align: center

   寄存器（和寄存器位字段）类型

寄存器初始值
*****************
主机控制器在上电复位时将所有寄存器设置为其初始值，所有其他寄存器的默认值应为设置为零的所有位。能力寄存器和最大当前能力寄存器的值取决于主机控制器，主机控制器版本寄存器的值也取决于主机控制器。

寄存器的保留位
******************
“保留”表示该位可定义供将来使用，当前设置为0。这些位应写为0。
