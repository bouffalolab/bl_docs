========
功能描述
========
BL616/BL618 系统架构如下所示:

.. figure:: ../../picture/SystemArch.svg
   :align: center
   :scale: 100%

   系统架构图

CPU带有AXI和AHB两条总线，ROM，Flash和PSRAM挂在 AXI 总线上，以实现对这些存储单元的高速访问，各个外设通过 AHB 总线与 CPU 连接在一起。

CPU
====
BL616/BL618 内置一颗 32-bit RISC-V CPU，它采用5级流水线结构：取指、译码、执行、内存访问、写回，
支持 RISC-V 32/16 位混编指令集，包含 64 个外部中断源，有 4 个 bits 可以用于配置中断优先级。

缓存
=============
BL616/BL618 的缓存提高了 CPU 访问外部存储器的效能，包含 32K 指令 cache 和 16K 数据 cache。

内存
=============
BL616/BL618 存储器包括：片上零延迟SRAM存储器 ，只读存储器，一次写入存储器，
嵌入式闪存（可选），嵌入式pSRAM（可选）。


DMA控制器
==========
BL616/BL618 DMA（直接存储器访问）控制器具有 4 个专用通道，用于管理外设和存储器之间的数据传输，以
提高 CPU /总线效率。DMA 有四种传输类型，内存到内存，内存到外设、外设到内存以及外设到外设四种模式。

DMA还支持 LLI（链接列表项）功能，该链表由一系列链接列表预定义多个传输，然后硬件会根据每个 LLI 的大小和地址自
动完成所有传输。

DMA 支持的外设包括 UART、I2C、SPI、Audio(Audio ADC和Audio DAC)、GPIO、I2S、DBI、
GPADC、GPDAC。

地址映射
=========
.. table:: 内存地址映射 
    :widths: 25, 25, 25, 25
    :width: 100%
    :align: center

    +-----------------+-------+-------------+----------------+
    |  模块           | 大小  |  开始地址                    |
    +                 +       +-------------+----------------+
    |                 |       | Cache       | Non-cache      |
    +=================+=======+=============+================+
    | OCRAM           | 320KB | 0x62FC0000  | 0x22FC0000     |
    +-----------------+-------+-------------+----------------+
    | WRAM            | 160KB | 0x63010000  | 0x23010000     |
    +-----------------+-------+-------------+----------------+

OCRAM 和 WRAM 既可以通过 AHB 总线访问，也可以通过 AXI 访问，当 CPU 使用 0x62FC0000 地址访问 OCRAM 时，会经过内部 Cache 并通过 AXI 转 AHB 实现对 OCRAM 的访问，
当 CPU 使用 0x22FC0000 地址访问 OCRAM 时，不会经过内部 Cache 并且直接通过 AHB 总线访问 OCRAM 。

.. table:: 地址映射 
    :widths: 11, 15,15,8,51
    :width: 100%
    :align: center

    +---------------+---------------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    |  模块         |  目标         |  开始地址             | 大小  |         描述                                                                                              |
    +===============+===============+=======================+=======+===========================================================================================================+
    | FLASH         | Flash         | 0xA0000000            | 128MB | 应用程序地址空间                                                                                          |
    +---------------+---------------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    | PSRAM         | pSRAM         | 0xA8000000            | 128MB | pSRAM 存储器地址空间(可选项，依赖芯片具体型号)                                                            |
    +---------------+---------------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    | RAM           | HBN RAM       | 0x20010000            | 4KB   |HBN RAM,主要用于超低功耗模式下的数据保存                                                                   |
    +---------------+---------------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    | Peripheral    | USB           | 0x20072000            | 4KB   | USB High Speed OTG 控制寄存器                                                                             |
    +               +---------------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    |               | EMAC          | 0x20070000            | 4KB   | EMAC 控制寄存器                                                                                           |
    +               +---------------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    |               | SDH           | 0x20060000            | 4KB   | SDH 控制寄存器                                                                                            |
    +               +---------------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    |               | MJPEG         | 0x20059000            | 4KB   | MJPEG 图像编码控制寄存器                                                                                  |
    +               +---------------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    |               | DVP           | 0x20057000            | 4KB   | DVP 摄像头接口控制寄存器                                                                                  |
    +               +---------------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    |               | Efuse         | 0x20056000            | 4KB   | Efuse存储控制寄存器                                                                                       |
    +               +---------------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    |               | AUDIO DAC     | 0x20055000            | 4KB   | Audio DAC 控制寄存器                                                                                      |
    +               +---------------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    |               | PSRAM_Ctrl    | 0x20052000            | 4KB   | PSRAM 控制寄存器                                                                                          |
    +               +---------------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    |               | HBN           | 0x2000F000            | 4KB   | 深度睡眠控制（休眠）寄存器                                                                                |
    +               +---------------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    |               | PDS           | 0x2000E000            | 4KB   | 睡眠控制（掉电睡眠）寄存器                                                                                |
    +               +---------------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    |               | SDU           | 0x2000D000            | 4KB   | SDU 控制寄存器                                                                                            |
    +               +---------------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    |               | DMA           | 0x2000C000            | 4KB   | DMA 控制寄存器                                                                                            |
    +               +---------------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    |               | SF_Ctrl       | 0x2000B000            | 4KB   | Serial Flash 控制寄存器                                                                                   |
    +               +---------------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    |               | Audio ADC     | 0x2000AC00            | 256B  | Audio ADC 控制寄存器                                                                                      |
    +               +---------------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    |               | I2S           | 0x2000AB00            | 256B  | I2S 控制寄存器                                                                                            |
    +               +---------------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    |               | I2C1          | 0x2000A900            | 256B  | I2C1 控制寄存器                                                                                           |
    +               +---------------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    |               | Display       | 0x2000A800            | 256B  | Display 控制寄存器                                                                                        |
    +               +---------------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    |               | IRR           | 0x2000A600            | 256B  | IR Receiver 控制寄存器                                                                                    |
    +               +---------------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    |               | TIMER         | 0x2000A500            | 256B  | TIMER 控制寄存器                                                                                          |
    +               +---------------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    |               | PWM           | 0x2000A400            | 256B  | PWM 控制寄存器                                                                                            |
    +               +---------------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    |               | I2C0          | 0x2000A300            | 256B  | I2C0 控制寄存器                                                                                           |
    +               +---------------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    |               | SPI           | 0x2000A200            | 256B  | SPI 控制寄存器                                                                                            |
    +               +---------------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    |               | UART1         | 0x2000A100            | 256B  | UART1 控制寄存器                                                                                          |
    +               +---------------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    |               | UART0         | 0x2000A000            | 256B  | UART0 控制寄存器                                                                                          |
    +               +---------------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    |               | TZ            | 0x20005000            | 4KB   | TrustZone 控制寄存器                                                                                      |
    +               +---------------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    |               | SEC_ENG       | 0x20004000            | 4KB   | 安全引擎控制寄存器                                                                                        |
    +               +---------------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    |               | GPIP          | 0x20002000            | 1KB   | 通用DAC/ADC/ACOMP接口控制寄存器                                                                           |
    +               +---------------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    |               | GLB           | 0x20000000            | 4KB   | 全局控制寄存器                                                                                            |
    +---------------+---------------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    | ROM           | ROM           | 0x90000000            | 128KB | Bootrom区域地址空间                                                                                       |
    +---------------+---------------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+

中断
=====
BL616/BL618 中断控制器支持 UART/I2C/SPI/Timer/DMA/EMAC/WiFi/BLE等共64个可屏蔽中断触发源。

所有 I/O 引脚都可以配置为外部中断输入模式，外部中断支持同步高/低电平触发、同步上升沿/下降沿触发、
异步高/低电平触发、异步上升沿/下降沿触发和同步双边沿触发共 9 种触发类型。

启动选项
=========
BL616/BL618 支持多种启动选项，可选择从 Flash/UART/USB/SDU 启动。

.. table:: 启动模式 has_header
    :widths: 13, 12,75
    :width: 100%
    :align: center

    +---------------+---------------+---------------------------------------------------------------------------------------------+
    |    启动引脚   |  电平         |   描述                                                                                      |
    +---------------+---------------+---------------------------------------------------------------------------------------------+
    | GPIO2         | 1             |  从 UART(GPIO21/22)/USB/SDU启动，该模式主要用于Flash烧写或者下载镜像到RAM执行(无线透传场景) |
    +               +---------------+---------------------------------------------------------------------------------------------+
    |               | 0             |  从 Flash 启动应用镜像                                                                      |
    +---------------+---------------+---------------------------------------------------------------------------------------------+

电源管理单元
=============
电源管理单元（PMU）管理整个芯片的电源，芯片中有 8 个电源域：PD_AON/PD_AON_HBNRTC/PD_AON_HBNCORE/PD_CORE/PD_CORE_MISC/PD_USB/PD_CPU/PD_WB。
可以实现的低功耗模式包括运行、空闲、睡眠(PDS)、休眠(HBN)和电源关闭。在睡眠(PDS)和休眠(HBN)模式下，可以有多种唤醒源将系统从低功耗模式唤醒。

时钟架构
=========
时钟控制单元为核心MCU和外围SOC设备生成时钟。时钟源可以是XTAL，PLL或RC振荡器。用户可以通过适当的配置（例如sel，div，en等）来设定各个外设的
时钟频率或者开关外设的时钟，以达到低功耗的应用需求。

.. figure:: ../../picture/clock_tree.svg
   :align: center
   :scale: 60%

   时钟框图

外设
======
外设包括 GPIO， UART， SPI， I2C， PWM， Timer， IR(RX)，
I2S， Audio(Audio ADC+Audio DAC)， SDU， MJPEG，
SD/MMC(SDH)， Ethernet MAC， GPDAC， GPADC， ACOMP， 
USB2.0。

GPIO
------
BL616 最多可达 19 个 GPIO，
BL618 最多可达 35 个 GPIO，
具有以下特性：

- 每个 GPIO 都可用作通用输入和输出功能，上拉/下拉/浮空可由软件配置
- 每个 GPIO 都支持中断功能，中断支持同步高/低电平触发、同步上升沿/下降沿触发、异步高/低电平触发、异步上升沿/下降沿触发和同步双边沿触发
- 每个 GPIO 均可设置为高阻态，用于低功耗模式
- 每个 GPIO 均可通过Set/Clear寄存器完成输出状态的控制
- 支持自定义的逻辑0/1波形输出
- 支持DMA

UART
------
芯片内置两个通用异步串行收发器(UART0/1)，具有以下特性：

- 支持硬件的 CTS 和 RTS 流控
- 支持 LIN 主/从功能
- 可配置的数据位、停止位和奇偶校验位
- 支持普通/固定字符的自动波特率检测
- 工作时钟可以选择为 FCLK 、XCLK 或 160MHz， 波特率最大支持 10Mbps
- TX 和 RX 具有独立 FIFO，FIFO深度为 32 字节，支持 DMA 功能

SPI
---------
芯片内置一个 SPI，可以配置为主机模式或者从机模式，SPI 模块时钟是 XCLK 或 160MHz，具有以下特性：

- 主机模式下，时钟频率最高为 80 MHz
- 从机模式下，允许主机最大的时钟频率为 80 MHz
- 每帧的位宽可以配置为 8 位/ 16 位/ 24 位/ 32 位
- 自适应的 FIFO 深度变化特性，适配高性能的场景应用
  
  * 当位宽为 32 位时，FIFO 的深度为 8
  * 当位宽为 24 位时，FIFO 的深度为 8
  * 当位宽为 16 位时，FIFO 的深度为 16
  * 当位宽为 8 位时，FIFO 的深度为 32
- 支持DMA传输模式

I2C
---------
芯片内置两个 I2C 接口，具有以下特性：

- 支持多主机模式和仲裁功能
- 工作时钟可以选择为 BCLK 或者 XCLK
- 具有器件地址寄存器，寄存器地址寄存器，寄存器地址长度可设置为 1 字节/ 2 字节/ 3 字节/ 4 字节
- I2C 具有独立收发 FIFO，FIFO 深度为 2 word
- 支持 DMA 功能

EMAC
--------------------
EMAC 模块是一个兼容 IEEE 802.3 的 10/100Mbps 以太网 MAC(Ethernet Media Access Controller)，具有以下特性：

- 兼容 IEEE 802.3 定义的 MAC 层功能
- 支持 IEEE 802.3 定义的 MII/RMII 接口的 PHY
- 通过 MDIO 接口与 PHY 交互
- 支持 10Mbps 与 100Mbps 以太网
- 支持半双工与全双工
- 在全双工模式下，支持自动流控及生成控制帧
- 在半双工模式下，支持碰撞检测及重传
- 支持 CRC 的生成及校验
- 数据帧前导生成及移除
- 发送时，自动扩展短的数据帧
- 检测过长或过短的数据帧 (长度限制)
- 可传输长数据帧 (> 标准以太帧长度) 
- 自动丢弃重发次数超限或帧间隙过小的数据包
- 广播包过滤
- 用于保存多达 128 个 BD(Buffer Descriptor) 的内部 RAM
- 在发送时，支持将一个数据包分拆配置到多个连续的 BD
- 发送/接收的各种事件标志
- 在事件发生时产生对应中断

EMAC 时序图如下所示：

.. figure:: ../../picture/EMACTiming.svg
   :align: center

   EMAC 时序图

.. table:: 使用 RX Clock 对应的时序条件
    :width: 100%
    :widths: 10, 20, 10, 10, 10, 10, 30
    :align: center

    +-----------------+--------------------+--------+--------+---------------------+--------+-----------------------+
    | 将寄存器 eth_cfg0 对应的位设置为：cfg_inv_eth_rx_clk = 1，cfg_inv_eth_tx_clk = 0，cfg_sel_eth_ref_clk_o = 0   |
    +-----------------+--------------------+--------+--------+---------------------+--------+-----------------------+
    | 时序参数（1.8V, Load = 20PF）        | 最小值 | 典型值 |  最大值             | 单位   | 备注                  |
    +=================+====================+========+========+=====================+========+=======================+
    | T\ :sub:`cyc`\  |Clock Cycle         | \-     | 20     | \-                  | ns     | Clock From ETH PHY    |
    +-----------------+--------------------+--------+--------+---------------------+--------+-----------------------+
    | T\ :sub:`vld`\  |Output Valid Delay  | 6.98   | \-     | 15.63               | ns     | TXD/TX_EN             |
    +-----------------+--------------------+--------+--------+---------------------+--------+-----------------------+
    | T\ :sub:`su`\   |Input Setup Time    | 11.64  | \-     | \-                  | ns     | RXD/RX_DV/RXERR       |
    +-----------------+--------------------+--------+--------+---------------------+--------+-----------------------+
    | T\ :sub:`h`\    |Input Hold Time     | 0      | \-     | \-                  | ns     | RXD/RX_DV/RXERR       |
    +-----------------+--------------------+--------+--------+---------------------+--------+-----------------------+

.. table:: 不使用 RX Clock 对应的时序条件
    :width: 100%
    :widths: 10, 20, 10, 10, 10, 10, 30
    :align: center

    +-----------------+--------------------+--------+--------+---------------------+--------+-----------------------+
    | 将寄存器 eth_cfg0 对应的位设置为：cfg_inv_eth_rx_clk = 0，cfg_inv_eth_tx_clk = 0，cfg_sel_eth_ref_clk_o = 0   |
    +-----------------+--------------------+--------+--------+---------------------+--------+-----------------------+
    | 时序参数（1.8V, Load = 20PF）        | 最小值 | 典型值 |  最大值             | 单位   | 备注                  |
    +=================+====================+========+========+=====================+========+=======================+
    | T\ :sub:`cyc`\  |Clock Cycle         | \-     | 20     | \-                  | ns     | Clock From ETH PHY    |
    +-----------------+--------------------+--------+--------+---------------------+--------+-----------------------+
    | T\ :sub:`vld`\  |Output Valid Delay  | 6.98   | \-     | 15.63               | ns     | TXD/TX_EN             |
    +-----------------+--------------------+--------+--------+---------------------+--------+-----------------------+
    | T\ :sub:`su`\   |Input Setup Time    | 3.5    | \-     | \-                  | ns     | RXD/RX_DV/RXERR       |
    +-----------------+--------------------+--------+--------+---------------------+--------+-----------------------+
    | T\ :sub:`h`\    |Input Hold Time     | 2      | \-     | \-                  | ns     | RXD/RX_DV/RXERR       |
    +-----------------+--------------------+--------+--------+---------------------+--------+-----------------------+


I2S
---------
芯片内置一个 I2S 接口，具有以下特性：

- 支持主模式以及从模式
- 支持 Left-justified/ Right-justified/ DSP 等数据格式，数据宽度可配置为 8/16/24/32 比特
- 工作时钟为 Audio PLL
- 除单声道/双声道模式之外，同时支持四声道与六声道模式
- 支持播放单声道音频复制为双声道模式
- 支持动态静音切换功能
- I2S 具有独立收发 FIFO，FIFO 深度为 16 word
- 支持 DMA 功能

TIMER
------------
芯片内置两个 32-bit 通用定时器和一个看门狗定时器，具有以下特性：

- 通用定时器的时钟源可以选择 FCLK/32K/XTAL，看门狗定时器的时钟源可以选择FCLK/32K/XTAL
- 每个计数器都有 8-bit 分频器
- 每组通用定时器都包含三个比较寄存器，支持比较中断，计数模式支持 FreeRun 模式和 PreLoad 模式
- 16-bit 看门狗定时器，支持中断或复位两种看门狗溢出方式

PWM
---------
芯片内置一组 PWM 信号，每组包含 4 通道 PWM 信号输出，每通道可以设置为 2 路互补 PWM，具有以下特性：

- 三种时钟源 BCLK/XCLK/32K 可供选择，搭配 16-bit 时钟分频器
- 每组 PWM 都可以独立设置为不同的周期
- 每通道 PWM 都有双门限值设定，可以设定不同的占空比和相位，增加脉冲弹性
- 每通道 PWM 都有独立的死区时间设定
- 每路 PWM 输出引脚都可以设定不同的有效电平
- 每路 PWM 都有独立的连接开关用来选择是否与内部计数器相连，并可设定不连接时的默认输出电平
- 刹车信号可以将 PWM 输出电平置于预先设定的状态
- 多达 11 种可用于触发 ADC 转换的触发源
- 支持多种中断类型：计数器溢出中断、门限值比较中断、周期数中断

IR(IR-remote)
------------------
芯片内置一个红外遥控，具有以下特性：

- 既支持以固定协议 NEC、 RC-5 接收数据，也支持以脉冲宽度计数方式接收任意格式数据
- 时钟源为 XCLK，最高工作频率为 40MHz
- 接收最多支持 64-bit 数据位
- 接收 FIFO 深度为 128 字节
- 支持接收结束中断

Audio ADC
---------
- 集成1路音频ADC（与高精度ADC不可同时使用），具有以下特性：

  * 采样率:8k~96k
  * 信噪比(A-W)：96dB@6dB增益，48K采样率
  * 谐波失真+噪声：-90dB@6dB增益，48K采样率
  * 模拟前置增益：6~42 dB, 3dB 一档 
  * 模拟全差分输入或单端输入

- 可调节的高通滤波器和数字音量控制
- 支持PDM接口（支持1路DMIC）
- 输入信号复用GPIO
- 32位宽度的发送FIFO，深度为8
- 支持DMA传输模式

Audio DAC
-------------
- 集成1路音频DAC，具有以下特性：

  * 采样率:8k~48k
  * 信噪比(A-W)：95dB@48K采样率
  * 谐波失真+噪声：-80dB@48K采样率

- 可调节的数字音量控制
- 支持差分互补输出
- 输出信号复用GPIO
- 32位宽度的发送FIFO，深度为16
- 支持DMA传输模式

GPADC
----------
芯片内置一个 12bits 的逐次逼近式模拟数字转换器 (ADC) ，具有以下特性：

- 单通道连续转换模式最高采样率可达 2M，其它转换模式最高采样率 500K
- 支持 12 路外部模拟通道
- 支持单通道单次转换、单通道连续转换、多通道单次转换、多通道连续转换
- 支持 2.0V，3.2V 可选内部参考电压，转换结果为 12/14/16bits(通过过采样实现) 左对齐模式
- 拥有深度为 32 字节的 FIFO，支持多种中断，支持 DMA 功能
- ADC 除了用于普通模拟信号测量外，还可以用于测量供电电压
- 可以通过测量内/外部二极管电压用于温度检测

高精度ADC
---------------
- 芯片内置1路高精度ADC（与audio CODEC不可同时使用），具有以下特性：

  * 支持全差分输入，4通道
  * 有效分辨率(ER)：19.5bit
  * 可编程增益放大器：6dB~42dB（2至128倍），3dB一档
  * 可编程数据传输率：20SPS、100SPS、200SPS、400SPS、1000SPS、2000SPS
  * 支持高精度/低延迟双套数字滤波器
  * 支持50Hz/60Hz 同步工频抑制
  * 支持软件全局斩波，ER=20.7bit，低于1uV的失调电压

- 复用GPIO输入信号
- 32位宽度的发送FIFO，深度为8
- 支持轮询、中断、DMA传输模式


