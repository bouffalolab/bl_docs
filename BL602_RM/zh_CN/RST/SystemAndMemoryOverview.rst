==================
系统和存储器概述
==================

简介
=========
芯片内处理器采用 RISC-V 32-bit 带浮点。
搭配高速处理内存系统 (详见 L1C 章节)，达到优质的运算效率。
处理器外部为多层 32-bit AHB 架构，具有低功耗、低延迟、高弹性的特性。
内存的部分包含高速紧耦合内存以及缓存和系统共享内存。
片外存储器支持 Flash 扩充。

主要特征
=================
• RISC-V 32-bit 带浮点
• 多层 32-bit AHB 总线架构
• 96KB 高速内存
• 180KB 系统内存
• 128KB 只读内存
• 片外存储器 Flash

功能描述
================

BL602/BL604总线连接与地址访问总结如下。
总线主设备包括CPU,SDIO,DMA,加密引擎,调试接口。
总线从设备包括内存,外设,WiFi/BLE。
除了加密引擎只能访问内存外，其余总线主设备皆可访问所有总线从设备。

.. table:: 总线连接

    +--------+------------+-------+--------+----------+---------+
    |  从/主 |  CPU       | SDIO  | DMA    |加密引擎  | 调试接口|
    +--------+------------+-------+--------+----------+---------+
    | 内存   | V          | V     | V      |      V   | V       |
    +--------+------------+-------+--------+----------+---------+
    | 外设   | V          | V     | V      |      -   | V       |
    +--------+------------+-------+--------+----------+---------+
    |WiFi/BLE| V          | V     | V      |      -   | V       |
    +--------+------------+-------+--------+----------+---------+


地址访问主要以[27:24]来区分"存储"或"外设"，可忽略[31:28]。
内存空间是连续的X2008000~X204BFFF (272KB SRAM)，只读内存X1000000，深度睡眠内存X0010000。
片外空间是X3000000 (最大支持 16MB Flash)。
外设空间是X0000000~X000F000。

.. table:: 地址映像

    +--------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    |  目标  |  开始地址             | 大小  |         描述                                                                                              |
    +--------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    | WRAM   | 0x42030000            | 112KB | 无线SRAM存储器                                                                                            |
    +--------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    | RETRAM | 0x40010000            | 4KB   | 深度睡眠内存（保留RAM）                                                                                   |
    +--------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    | HBN    | 0x4000F000            | 4KB   | 深度睡眠控制（休眠）                                                                                      |
    +--------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    | PDS    | 0x4000E000            | 4KB   | 睡眠控制（掉电睡眠）                                                                                      |
    +--------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    | SDU    | 0x4000D000            | 4KB   | SDIO控制                                                                                                  |
    +--------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    | DMA    | 0x4000C000            | 4KB   | DMA控制                                                                                                   |
    +--------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    | QSPI   | 0x4000B000            | 4KB   | Flash闪存控制                                                                                             |
    +--------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    | IRR    | 0x4000A600            | 256B  | 红外遥控器                                                                                                |
    +--------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    | TIMER  | 0x4000A500            | 256B  | 计时器控制                                                                                                |
    +--------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    | PWM    | 0x4000A400            | 256B  | 脉冲宽度调制控制                                                                                          |
    +--------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    | I2C    | 0x4000A300            | 256B  | I2C控制                                                                                                   |
    +--------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    | SPI    | 0x4000A200            | 256B  | SPI主/从控制                                                                                              |
    +--------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    | UART1  | 0x4000A100            | 256B  | UART控制                                                                                                  |
    +--------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    | UART0  | 0x4000A000            | 256B  | UART控制                                                                                                  |
    +--------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    | L1C    | 0x40009000            | 4KB   | 缓存控制                                                                                                  |
    +--------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    | eFuse  | 0x40007000            | 4KB   | eFuse存储器控制                                                                                           |
    +--------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    | TZ2    | 0x40006000            | 4KB   | 信任区隔离                                                                                                |
    +--------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    | TZ1    | 0x40005000            | 4KB   | 信任区隔离                                                                                                |
    +--------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    | SEC    | 0x40004000            | 4KB   | 安全引擎                                                                                                  |
    +--------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    | GPIP   | 0x40002000            | 4KB   | 通用DAC / ADC / ACOMP接口控制                                                                             |
    +--------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    | MIX    | 0x40001000            | 4KB   | 混合信号寄存器                                                                                            |
    +--------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    | GLB    | 0x40000000            | 4KB   | 全局寄存器                                                                                                |
    +--------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    | RAM    | 0x22020000/0x42020000 | 64KB  | 片上存储器,如果用作数据存储器，则使用0x42020000地址访问；如果用作程序存储器，则使用0x22020000地址访问     |
    +--------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    | XIP    | 0x23000000            | 16MB  | XIP闪存                                                                                                   |
    +--------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    | TCM1   | 0x22014000/0x42014000 | 48KB  | 紧耦合内存，如果用作数据存储器，则使用0x42014000地址访问；如果用作程序存储器，则使用0x22014000地址访问    |
    +--------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    | TCM0   | 0x22008000/0x42008000 | 48KB  | 紧耦合内存，如果用作数据存储器，则使用0x42008000地址访问；如果用作程序存储器，则使用0x22008000地址访问    |
    +--------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+
    | ROM    | 0x21000000            | 128KB | 只读存储器                                                                                                |
    +--------+-----------------------+-------+-----------------------------------------------------------------------------------------------------------+

中断源
============
BL602/BL604一共包含18个中断源，中断源与对应的中断号如下表所示：

.. table:: 中断分配 

    +-------+------------------+------------------+---------------------------------+
    | 中断源                   |   中断号         | 描述                            |
    +-------+------------------+------------------+---------------------------------+
    | L1C   | L1C_BMX_ERR      | IRQ_NUM_BASE+2   | L1C BMX Error Interrupt         |  
    +       +------------------+------------------+---------------------------------+
    |       | L1C_BMX_TO       | IRQ_NUM_BASE+3   | L1C BMX Timeout Interrupt       |
    +-------+------------------+------------------+---------------------------------+
    | DMA   | DMA_BMX_ERR      | IRQ_NUM_BASE+8   | DMA BMX Error Interrupt         |  
    +-------+------------------+------------------+---------------------------------+
    | IR    | IRTX             | IRQ_NUM_BASE+19  | IR TX Interrupt                 |  
    +       +------------------+------------------+---------------------------------+
    |       | IRRX             | IRQ_NUM_BASE+20  | IR RX Interrupt                 |
    +-------+------------------+------------------+---------------------------------+
    | ADC   | GPADC_DMA        | IRQ_NUM_BASE+25  | GPADC_DMA Interrupt             |  
    +-------+------------------+------------------+---------------------------------+
    | SPI   | SPI              | IRQ_NUM_BASE+27  | SPI Interrupt                   |
    +-------+------------------+------------------+---------------------------------+
    | UART  | UART0            | IRQ_NUM_BASE+29  | UART0 Interrupt                 |
    +       +------------------+------------------+---------------------------------+
    |       | UART1            | IRQ_NUM_BASE+30  | UART1 Interrupt                 |
    +-------+------------------+------------------+---------------------------------+
    | I2C   | I2C              | IRQ_NUM_BASE+32  | I2C Interrupt                   |
    +-------+------------------+------------------+---------------------------------+
    | PWM   | PWM              | IRQ_NUM_BASE+34  | PWM Interrupt                   |
    +-------+------------------+------------------+---------------------------------+
    | TIMER | TIMER_CH0        | IRQ_NUM_BASE+36  | Timer Channel 0 Interrupt       |
    +       +------------------+------------------+---------------------------------+
    |       | TIMER_CH1        | IRQ_NUM_BASE+37  | Timer Channel 1 Interrupt       |
    +       +------------------+------------------+---------------------------------+
    |       | TIMER_WDT        | IRQ_NUM_BASE+38  | Watch Dog Interrupt             |
    +-------+------------------+------------------+---------------------------------+
    | GPIO  | GPIO_INT0        | IRQ_NUM_BASE+44  | GPIO Interrupt                  |
    +-------+------------------+------------------+---------------------------------+
    | PDS   | PDS_WAKEUP       | IRQ_NUM_BASE+50  | PDS Wakeup Interrupt            |
    +-------+------------------+------------------+---------------------------------+
    | HBN   | HBN_OUT0         | IRQ_NUM_BASE+51  | Hibernate out 0 Interrupt       |
    +       +------------------+------------------+---------------------------------+
    |       | HBN_OUT1         | IRQ_NUM_BASE+52  | Hibernate out 1 Interrupt       |
    +-------+------------------+------------------+---------------------------------+

.. note::
    其中IRQ_NUM_BASE为16，中断号0-15为RISC-V 保留中断。
