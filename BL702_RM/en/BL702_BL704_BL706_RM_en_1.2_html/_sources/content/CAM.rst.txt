==========
CAM
==========

CAM introduction
===================
The CAM (Camera) module is responsible for converting the parallel interface (DVP) into a general bus interface (AHB), and writes the pixel data generated by the image sensor into the system memory in a flat or packed format for subsequent image transmission or compression. The CAM module has a flexible output format configuration that can meet a variety of image processing needs.

.. figure:: ../../picture/Cam_Arch.jpg
   :align: center

   Cam block diagram

CAM main features
==================

- Parallel interface 8-bit DVP signal, high-speed data transmission (80M), configurable DVP signal effective level and logical combination
- Support YCbCr4:2:2 input format in any order
- Support plane or packed mode to store image data
- Support movie mode and photo mode
- Configurable output format, including:
  * YCbCr4:2:2
  * YCbCr4:2:0
  * YCbCr4:0:0
- Configurable image sensor line and frame synchronization signal selection and polarity selection
- Support image rectangle cropping
- Support integrity detection of line frame synchronization signal
- AHB bus communication interface
- 256-byte buffer FIFO to cope with the occasional busy state of the bus
- Continuously cache up to 8 sets of picture information
- A variety of application interruptions are conducive to flexible use and error notification

CAM function description
==============================
DVP (Digital Video Port) signal and configuration
--------------------------------------------------------
DVP (Digital Video Port) is a parallel interface, mainly including clock, frame synchronization, line synchronization and 8-bit data pins. The limit of the clock is limited to 80MHz, so it is generally used for sensors with resolutions below 5MP. The effective level of frame synchronization and line synchronization can be independently configured in the chip, and four modes are provided on the effective data:

A. Frame synchronization and line synchronization are valid at the same time ("&" logic)

B. Frame synchronization or line synchronization is valid alternatively ("|" logic)

C. Frame synchronization is valid

D. Line synchronization is valid

YCbCr format
------------
The luminance signal is called Y, and the chrominance signal is composed of two independent signals. Depending on the color system and format, the two chrominance signals are often referred to as U, V or Pb, Pr or Cb, Cr. This is produced by different encoding formats, but in fact their concepts are basically the same.

Since the human retina has more retinal rod cells that recognize brightness than retinal cone cells that recognize chromaticity, the human eye is more sensitive to brightness than to chromaticity. Therefore, part of the chromaticity information can be discarded without being noticed by human eyes.

The format with the highest resolution of the chrominance signal is 4:4:4, that is, every 4 points of Y samples corresponds to 4 points of Cb and 4 points of Cr samples. And 4:2:2 means that every 4 points of Y samples correspond to 2 points of Cb and 2 points of Cr samples. In this format, the number of scan lines of the chrominance signal is as many as that of the luminance signal. But the chroma sampling point on each scan line is only half of the luminance signal. Different from the format mentioned above, 4:2:0 does not correspond to 2 points of Cb and 0 points of Cr sampling for every 4 points of Y sampling, but every 4 points of Y sampling corresponds to 1 point of Cb and 1 point of Cr sampling. 4:0:0 is to discard all the chrominance information, that is, the grayscale image.

Plane mode/Packed mode
------------------------
When using the plane mode, set the start addresses of the two non-overlapping memory spaces by setting the registers DVP2AHB_ADDR_START_0 and DVP2AHB_ADDR_START_1, and set the corresponding sizes of the two memory spaces by setting the registers DVP2AHB_MEM_BCNT_0 and DVP2AHB_MEM_BCNT_1. One block is used to store the Y information of all pixels, and one block is used to store the CbCr information of all pixels.

When using the packing mode, it is only necessary to set a memory space by setting DVP2AHB_ADDR_START_0 and DVP2AHB_MEM_BCNT_0, in which the Y, Cb, and Cr information of each pixel is continuously stored alternately.

Movie mode/Photo mode
-----------------------
The photo mode can be set by the bit <REG_FRAME_CNT_TRGR_INT> of the register INT_CONTROL to set the number of frames to be captured each time. After starting, the set number of frames (1-16) will be continuously cached and the capture will stop immediately.

The movie mode will continuously rewrite the fixed size memory given by the software, that is, the concept of using the memory as a ring buffer, and use it to ensure that the picture is taken out in real time or linked with the MJPEG module.

Image rectangle crop
----------------------
Set the start and end positions of the line sync signal and frame sync signal cropping through the high 16 bits and low 16 bits of the registers HSYNC_CONTROL and VSYNC_CONTROL. The image in the rectangular window with the specified position and size can be cropped, and the data beyond the rectangle will be discarded. Among them, the start and end of the line synchronization signal are set to byte sequence numbers (ie, pixel point number*2), and the start and end of the frame synchronization signal are set to line numbers. The cropped image contains the start point but not the end point.

Line frame synchronization signal integrity detection
--------------------------------------------------------
Through the low 16 bits and high 16 bits of the FRAME_SIZE_CONTROL register, the comparison value of the line synchronization signal and the comparison value of the frame synchronization signal can be set respectively, and the integrity of the signal can be detected. The line synchronization signal sets the total number of bytes per line, that is, the number of pixels contained in each line*2, and the frame synchronization signal sets the total number of lines. When the count value of the line or frame synchronization signal of a frame of image is not equal to the comparison value, a corresponding interrupt is generated.

Cache picture information
-------------------------------
The module contains 16 groups of FIFO to record the picture address and picture size. When the storage mode is in the packed mode, only 8 groups are used, and when the plane mode is used, because Y and CbCr are stored separately, 16 groups are used. Whenever this module writes a complete frame to the memory, it will record the start address and picture size of this frame in this FIFO. But it should be noted that when there is insufficient memory remaining or 8/16 groups of FIFOs are full, the module will automatically discard the message of the next picture. In the part of the picture information taken out, the pop action can be done through the APB interface. Empty the oldest picture information, at this time the FIFO will automatically advance to ensure the timing of the picture information inside the FIFO, as shown below:

.. figure:: ../../picture/Cam_Frame_FIFO.jpg
   :align: center

   FIFO framework

Support multiple interrupt information (independent switch configuration)
--------------------------------------------------------------------------
A. Normal interruption-can be set to interrupt after writing a few pictures

B. Memory interrupt-when the memory is overwritten, an interrupt is issued

.. figure:: ../../picture/Cam_Mem.jpg
   :align: center

   RAM

C. Frame interrupt-when the unprocessed pictures exceed 8/16 groups, an interrupt is issued

D. FIFO interrupt-send an interrupt when the bus is too late to write to the memory and cause FIFO overflow

E. Hsync interrupt-when the number of pixels in a line of a frame of image is not equal to the set value, an interrupt is issued

F. Vsync interrupt-when the total number of lines in a frame of image is not equal to the set value, an interrupt is issued

