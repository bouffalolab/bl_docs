==========
CAM
==========

简介
=====
CAM(Camera)模块负责将并行接口(DVP)转换成一般总线接口(AHB)，把图像传感器生成的像素数据以平面或打包格式写入系统内存中，作为后续影像传输或压缩使用。CAM模块拥有灵活的输出格式配置，可以满足多种多样的图像处理需求。

.. figure:: ../../picture/Cam_Arch.jpg
   :align: center

   Cam框图

主要特征
=========

 - 并行接口8-bitDVP信号，高速数据传输(80M)，可配置DVP信号有效水平与逻辑组合
 - 支持任意排列顺序的YCbCr4:2:2输入格式
 - 支持平面或打包模式存储图像数据
 - 支持影片模式和照片模式
 - 可配置的输出格式，包括：
  * YCbCr4:2:2
  * YCbCr4:2:0
  * YCbCr4:0:0
 - 可配置的图像传感器行帧同步信号选择和极性选择
 - 支持图像矩形裁剪
 - 支持行帧同步信号的完整性检测
 - AHB总线通信接口
 - 256字节缓存FIFO以应对总线偶而忙碌的状态
 - 连续缓存多达8组图片信息
 - 多种应用中断，有利于弹性使用与出错提示

功能描述
=========
DVP(Digital Video Port)信号与配置
------------------------------------------
DVP（Digital Video Port）是并行接口，主要有时钟，帧同步，行同步与8-bit数据管脚，时钟的极限限制在80MHz，所以一般用于5MP以下分辨率Sensor。芯片内可独立配置帧同步与行同步的有效电平，并在有效数据上提供四种模式: 

A.	帧同步与行同步同时有效(“&”逻辑)

B.	帧同步或行同步择一有效(“|”逻辑)

C.	帧同步有效

D.	行同步有效

YCbCr格式
------------
亮度信号被称为Y，色度信号是由两个互相独立的信号组成。视颜色系统和格式不同，两种色度信号经常被称为U、V或Pb、Pr或Cb、Cr。这是由不同的编码格式产生的，但实际上它们的概念基本相同。

由于人类视网膜上识别亮度的视网膜杆细胞要多于识别色度的视网膜锥细胞，人眼对亮度的敏感程度要高于对色度的敏感程度。所以可以将色度信息丢弃一部分而不被人眼所察觉。

色度信号分辨率最高的格式是4:4:4，即每4点Y采样对应了4点Cb和4点Cr采样。而4:2:2是每4点Y采样对应了2点Cb和2点Cr采样，在这种格式中，色度信号的扫描线数量和亮度信号一样多，但是每条扫描线上的色度采样点却只有亮度信号的一半。与上面提到的格式不同，4:2:0并不是每4点Y采样对应2点Cb和0点Cr采样，而是每4点Y采样对应1点Cb和1点Cr采样。4:0:0是丢弃所有的色度信息，即灰度图。

平面模式/打包模式
--------------------
平面模式使用时通过设置寄存器DVP2AHB_ADDR_START_0和DVP2AHB_ADDR_START_1分别设置两块不重叠的内存空间的起始地址，通过设置寄存器DVP2AHB_MEM_BCNT_0和DVP2AHB_MEM_BCNT_1分别设置两块内存空间对应的大小。其中一块用于存储所有像素点的Y信息，一块用于存储所有像素点的CbCr信息。

打包模式使用时只需要通过设置DVP2AHB_ADDR_START_0和DVP2AHB_MEM_BCNT_0来设置一块内存空间，其中每个像素点的Y、Cb、Cr信息连续交替存储。

影片模式/照片模式
---------------------
照片模式可通过寄存器INT_CONTROL的位<REG_FRAME_CNT_TRGR_INT>设定每次需要抓拍张数，启动后连续缓存设定的张数(1-16)后立即停止抓图。

影片模式则会在软件给的固定大小的记忆上不停地复写，也就是将内存当作ring buffer的概念，使用上要确保图片被实时取出或是跟着MJPEG模块做连动。

图像矩形裁剪
---------------
通过寄存器HSYNC_CONTROL和VSYNC_CONTROL的高16位和低16位分别设置行同步信号和帧同步信号裁剪的起始和结束位置，就可以将指定位置和大小的矩形窗口内的图像裁剪下来，超出矩形部分的数据会被丢弃。其中行同步信号起始和结束设置的是字节序号(即像素点序号*2),帧同步信号起始和结束设置的是行号，裁剪后的图像包含起始点而不包含结束点。

行帧同步信号完整性检测
-------------------------
通过寄存器FRAME_SIZE_CONTROL的低16位和高16位可以分别设置行同步信号比较值和帧同步信号比较值，可以对信号的完整性进行检测。其中行同步信号设置的是每行的总字节数，即每行所包含的像素点数*2，帧同步信号设置的是总行数。当一帧图像的行或帧同步信号计数值与比较值不相等时，会有对应的中断产生。

缓存图片信息
-------------
模块内部包含16组FIFO记录图片地址和图片大小，当存储模式使用的是打包模式时，只使用其中的8组，而使用平面模式时由于Y和CbCr分开存储，则会使用16组。每当此模块完整写入一帧到内存，便会将此帧图片的起始地址和图片大小纪录于此FIFO中，但要注意的是当发生内存剩余不足，或是8/16组FIFO满存的状况时，模块会自动丢掉接下来图片的讯息，在图片信息取出的部分，可通过APB接口做pop的动作，将最旧的图片信息空出，此时FIFO会自动推进，保证FIFO内部图片信息的时序，如下图 :

.. figure:: ../../picture/Cam_Frame_FIFO.jpg
   :align: center

   FIFO框架

支持多种中断信息(可独立开关配置)
-------------------------------------
A、Normal 中断 – 可设定固定写入几张图片后发出中断

B、Memory 中断 – 当内存被复写时，发出中断

.. figure:: ../../picture/Cam_Mem.jpg
   :align: center

   内存

C、Frame 中断 – 当未处理图片超过8/16组时，发出中断

D、FIFO 中断– 总线来不及写入内存导致FIFO溢出时，发出中断

E、Hsync 中断 - 当一帧图像中某行的像素点数与设置值不相等时，发出中断

F、Vsync 中断 - 当一帧图像的总行数与设置值不相等时，发出中断

