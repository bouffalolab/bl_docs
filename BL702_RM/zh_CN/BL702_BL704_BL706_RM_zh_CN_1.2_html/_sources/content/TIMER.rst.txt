==========
TIMER
==========

简介
=====
芯片内置2组32-bit 计数器，每个计数器可独立配置其参数与时钟频率。

芯片内有一组看门狗计数器，不可预知的软件或硬件行为有可能导致应用程序工作失常，
看门狗定时器可以帮助系统从中恢复，如果当前阶段超过预定时间，
但没有喂狗或关闭看门狗定时器，可依设定触发中断或系统复位。

.. figure:: ../../picture/TimerBlock.svg
   :align: center

   定时器框图

.. figure:: ../../picture/WatchdogBlock.svg
   :align: center

   看门狗定时器框图

主要特征
=========
- 多种时钟来源选择
- 8-bit 时钟分频器，分频系数为1-256
- 两组32-bit定时器
- 每个定时器包含三组报警值设定，可独立设定每组报警值溢出时报警
- 支持FreeRun模式和PreLoad模式
- 16-bit 看门狗定时器
- 支持写入密码保护，防止误设定造成系统异常
- 支持中断或复位两种看门狗溢出方式

功能描述
==========

8-bit分频器
-------------
看门狗定时器时钟有3种选择：

- Fclk--系统主时钟

- 32K--32K时钟

- Xtal--外部晶振

每个定时器时钟来源都有四种选择，来源如下：

- Fclk--系统主时钟

- 32K--32K时钟

- 1K--1K时钟（32K的分频）

- Xtal--外部晶振

每个计数器有各自的8-bit分频器，可通过APB将选择到的时钟进行1-256的分频，
具体来说设定为0时表示不分频，设定为1时进行2分频以此类推，
最大分频系数为256，
计数器将以分频后的时钟作为计数周期单位，每经过一个计数周期进行上数一的动作。

通用定时器工作原理
--------------------
每个通用定时器都包含三组比较器，一个计数器以及一个预加载寄存器，当设定好时钟源，
启动定时器后，计数器开始向上累加计数，当计数器的值与比较器相等的时候，
比较标志置位同时可以产生比较中断。

计数器的初始值取决于定时的模式，在FreeRun模式下，计数器的初始值是0，然后累加计数，
当达到计数最大值后，然后从0再次开始计数。

在PreLoad模式下，计数器的初始值是PreLoad寄存器的值，然后向上累加计数，
当满足PreLoad条件时，计数器的值被置为PreLoad寄存器的值，然后计数器再次开始向上累加计数，
在定时器的计数器计数过程中，一旦计数器的值与三个比较器中的某比较值一致，
该比较器的比较标志就会置位，并可以产生相应的比较中断。

若预加载寄存器的值为10，比较器0的值为13，比较器1的值为16，比较器2的值为19，
则定时器在PreLoad的模式下工作时序如下图：

.. figure:: ../../picture/TimerPreload.svg
   :align: center

   定时器在PreLoad模式下工作时序

在FreeRun模式下，定时器工作时序与PreLoad基本相同，
只是计数器会从0开始累计到最大值，期间产生的比较标志和比较中断的机制与PreLoad模式相同。

看门狗定时器工作原理
----------------------
Watchdog定时器包含一个计数器和一个比较器，计数器从0开始累加计数，
如果计数器被复位(喂狗)，则从0再次开始向上计数，当计数器的值与比较器相等的时候，
可以产生一个比较中断信号或者系统复位信号，用户可以根据需要选择使用其中一个。
看门狗计数器会在每个计数周期单位上加1，软件可以在任何时间点通过APB将看门狗计数器归零。

若比较器的值为6,Watchdog的工作时序如下图所示

.. figure:: ../../picture/WatchDog.svg
   :align: center

   Watchdog工作时序

报警设定
-----------
每一组计数器有三个比较值提供软件设定，并可设定每一组比较值是否触发报警中断，
当计数器与比较值吻合且设定会报警时，计数器会通过中断通知处理器。
软件可以通过APB读取目前是否发生报警和是哪个比较值触发报警中断，
当清理报警中断时亦会同步清理报警状态。

看门狗报警
-----------
每个计数器可设定一组比较值，当软件因为系统错误，
来不及将看门狗计数器归零，
导致看门狗计数器超过比较值时，便会触发看门狗报警，报警方式有两种，
第一种是通过中断通知软件进行必要的处置，第二种是进入系统看门狗复位，
看门狗复位被触发时，会通知系统复位控制器，并做好系统复位前准备，
当一切就绪后进入系统看门狗复位，值得注意的是，软件可通过APB读取WSR 
寄存器得知是否曾经发生看门狗系统复位。

.. figure:: ../../picture/WatchDogAlarm.svg
   :align: center

   看门狗报警机制

.. only:: html

   .. include:: tmr_register.rst

.. raw:: latex

   \input{../../zh_CN/content/tmr}