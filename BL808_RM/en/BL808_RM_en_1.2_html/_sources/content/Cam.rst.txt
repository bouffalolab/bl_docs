==========
CAM
==========

Overview
=========
The Camera (CAM) module converts the parallel interface (DVP) into the general bus interface (AHB), and writes the pixel data generated by the image sensor into the system memory in a flat or packaged format for subsequent image transfer or compression. With flexible output format configuration, CAM can meet various image processing requirements.

.. figure:: ../../picture/CamArch.svg
   :align: center

   Block Diagram of Cam

Features
=========

- Parallel interface with 8-bit DVP signal, high-speed data transfer (80M), and configurable valid level and logical combination of DVP signal

- Supports 8-bit/16-bit/24-bit input pixel bit width

- Supports up to 36 data input sources

- Supports conversion of RGB888 input format to RGB565 or RGBA8888 output format

- Supports movie and photo modes

- Configurable discard modes:

   * Discard odd-bit data

   * Discard even-bit data

   * Discard odd-bit data of odd lines

   * Discard even-bit data of odd lines

- Configurable line and frame synchronization signal selection and polarity selection of image sensor

- Supports rectangle cropping of image

- Supports integrity test of line and frame synchronization signals

- AHB bus communication interface

- FIFO with 512-byte cache to assist occasional busy bus

- Caches up to 4 images continuously

- Multiple application interrupts are beneficial to flexible use and error prompt

Functional Description
=========
DVP(Digital Video Port) signal and configuration
------------------------------------------
Digital Video Port (DVP), a parallel interface, provides clock, frame synchronization, line synchronization, and 8-bit data pins. The clock limit is 80 MHz, so it is generally used for sensors with resolution below 5 MP. The active levels of frame and line synchronization can be independently configured on the chip, and four modes are provided on the valid data:

1. Frame synchronization and line synchronization are valid at the same time ("&" logic)

2. Either frame synchronization or line synchronization is valid ("\|" logic)

3. Frame synchronization is valid

4. Line synchronization is valid

YCbCr Format
------------
The luminance signal is also called Y signal. The chrominance signal is composed of two independent signals. Depending on the color system and format, the two chrominance signals are often called U & V, Pb & Pr, or Cb & Cr. They use different coding formats, but their concepts are essentially the same.

As there are more retinal rod cells that recognize brightness than the retinal cone cells that recognize chrominance in the human retina, human eyes are more sensitive to brightness than to chrominance. Thus, a part of chrominance information can be discarded without being perceived by human eyes.

The chrominance signal with the highest resolution is denoted as 4:4:4. That is, every 4-point Y sample corresponds to 4-point Cb and 4-point Cr samples. Similarly, 4:2:2 means that every 4-point y sample corresponds to 2-point Cb and 2-point Cr samples. The number of scan lines of chrominance signal is as large as that of luminance signal, but the chrominance sampling points on each scan line are only half of that of luminance signal. Different from the format described above, 4:2:0 does not mean that every 4-point Y sample corresponds to 2-point Cb and 0-point Cr samples, but means that every 4-point Y sample corresponds to 1-point Cb and 1-point Cr samples. The format 4:0:0 means discarding all the chrominance information, namely grayscale image.

Input Source
-----------
The data input source of CAM can be selected through configuration, and the relationship between configuration values and input sources is shown as follows:

.. figure:: ../../picture/CamInput.svg
   :align: center

   Input Source Selection

Movie /Photo mode
---------------------
In the photo mode, when the fixed-size memory provided by software is full, CAM will stop writing, and continue to write after the software performs POP operation for freeing up space.

In the movie mode, CAM will consecutively write in the fixed-size memory provided by software. That is, the memory will work as a ring buffer and no POP operation is required. In practice, it is necessary to ensure that images are taken out in real time or linked with the MJPEG module.

Rectangular Cropping of Image
---------------
You need to set the start and end positions for cropping line and frame synchronization signals by configuring the high 16 bits and low 16 bits of the registers HSYNC_CONTROL and VSYNC_CONTROL. Then, the image within the rectangular window marked based on the specified positions and size can be cropped and the remaining part beyond the window will be discarded. The start and end positions of the line synchronization signal are set by pixel numbers, while that of the frame synchronization signal are set by line numbers. The cropped image includes the start point but excludes the end point.

Integrity Test of Line and Frame Synchronization Signals
-------------------------
You can test the signal integrity by setting comparison values for line and frame synchronization signals respectively by configuring the low 16 bits and high 16 bits of the register FRAME_SIZE_CONTROL. The total number of pixels in each line is set for the line synchronization signal, and the total number of lines is set for the frame synchronization signal. When the count value of a line or frame synchronization signal of a frame of image is unequal to the comparison value, an interrupt will be generated.

Cached Image Information
-------------
The module has four FIFOs to record the address and size of images. Every time this module completely writes a frame into the memory, it will record the start address and image size of this frame of image in FIFO. However, when the memory is insufficient or four FIFOs are full, it will automatically discard the information of the incoming image. In the part where the image information has been taken out, the oldest image information will be removed by performing the pop operation through APB. Then, FIFO will automatically push data to ensure the timing of the image information in FIFO, as shown below:

.. figure:: ../../picture/CamFrameFIFO.svg
   :align: center

   FIFO Framework

Multiple Interrupts (Separately Configured)
-------------------------------------
A. Normal interrupt: You can set to generate an interrupt after a fixed number of images are written

B. Memory interrupt: When the memory is rewritten, an interrupt will be generated

.. figure:: ../../picture/CamMem.svg
   :align: center

   Memory

C. Frame interrupt: When there are more than 4 unprocessed images, an interrupt will be generated

D. FIFO interrupt: When the bus is too late to be written into memory and FIFO overflows, an interrupt will be generated

E. Hsync interrupt: When the number of pixels in a line in a frame of image is unequal to the set value, an interrupt will be generated

F. Vsync interrupt: When the total number of lines of a frame of image is unequal to the set value, an interrupt will be generated

.. only:: html

   .. include:: dvp2axi_register.rst

.. raw:: latex

   \input{../../en/content/dvp2axi}