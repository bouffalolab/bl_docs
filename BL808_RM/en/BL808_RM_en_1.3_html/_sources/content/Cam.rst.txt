==========
CAM
==========

Overview
=====
The CAM (Camera) module is responsible for converting the parallel interface (DVP) into a general bus interface (AHB), and writing the pixel data generated by the image sensor into the system memory for subsequent image transmission or compression. The CAM module has a flexible output format configuration, which can meet a variety of image processing needs.

.. figure:: ../../picture/CamArch.svg
   :align: center

   CAM block diagram

Features
=========

- Parallel interface 8-bit DVP signal, high-speed data transmission (80M), configurable DVP signal effective level and logic combination
- Support 8-bit/16-bit/24-bit input pixel width
- Support converting RGB888 input format to RGB565 or RGBA8888 output
- Support movie mode and photo mode
- Configurable drop patterns including:

   * Discard odd-digit data
   * Discard even-digit data
   * Discard odd-numbered data in odd-numbered rows
   * Discard even-digit data of odd-numbered rows

- Configurable image sensor line frame sync signal selection and polarity selection
- Support image rectangle cropping
- Frame selection function with a cycle of 1~32
- Support integrity detection of line frame synchronization signal
- AHB bus communication interface
- 512-byte buffer FIFO for occasional busy bus status
- Continuously cache up to 4 sets of image information
- A variety of application interruptions are conducive to flexible use and error prompts

Function description
=========
DVP (Digital Video Port) signal and configuration
------------------------------------------
DVP (Digital Video Port) is a parallel interface, mainly including clock, frame synchronization, line synchronization and 8-bit data pins. The limit of the clock is limited to 80MHz, so it is generally used for sensors with resolutions below 5MP. The effective level of frame synchronization and line synchronization can be independently configured in the chip, and four modes are provided on the effective data:

A. Frame sync and line sync are active at the same time ("&" logic)

B. Either frame sync or line sync is valid ("|" logic)

C. Frame synchronization is valid

D. Line synchronization is valid

YCbCr format
------------
The luminance signal is called Y, and the chrominance signal is composed of two independent signals. Depending on the color system and format, the two chrominance signals are often referred to as U, V or Pb, Pr or Cb, Cr. This results from different encoding formats, but in fact they have basically the same concept.

Since there are more retinal rod cells that recognize brightness than retinal cone cells that recognize chrominance on the human retina, the human eye is more sensitive to brightness than to chrominance. Therefore, part of the chrominance information can be discarded without being perceived by the human eye.

The format with the highest resolution of the chrominance signal is 4:4:4, that is, every 4-point Y sampling corresponds to 4-point Cb and 4-point Cr sampling. And 4:2:2 is that every 4 points of Y sampling corresponds to 2 points of Cb and 2 points of Cr sampling. In this format, the number of scan lines for chrominance signals is as many as that for luminance signals, but the color of each scan line is The degree sample points are only half of the luminance signal. Different from the format mentioned above, 4:2:0 does not correspond to 2 points of Cb and 0 points of Cr sampling for every 4 points of Y sampling, but corresponds to 1 point of Cb and 1 point of Cr sampling for every 4 points of Y sampling. 4:0:0 is to discard all chrominance information, that is, the grayscale image.

Movie Mode/Photo Mode
---------------------
In the photo mode, when the fixed-size memory given by the software is full, the CAM will stop, and the software will need to perform a POP operation to free up the space before continuing to write.

In video mode, it will keep rewriting on the fixed-size memory provided by the software, that is, using the memory as a ring buffer, without software for POP operation, to ensure that the image is taken out in real time or linked with the MJPEG module.

RGB888 to RGB565/RGBA8888 output
----------------------------------------
For image data whose input format is RGB888, you can choose to convert it to RGB565 or RGBA8888 and write it to the memory. If it is converted to RGB565 format, the arrangement order of R, G, B can be controlled by the bit FORMAT_565 of the register MISC. The arrangement order corresponding to different values is as follows:

 - 0: byte2[7:3],byte1[7:2],byte0[7:3]
 - 1: byte1[7:3],byte2[7:2],byte0[7:3]
 - 2: byte2[7:3],byte0[7:2],byte1[7:3]
 - 3: byte0[7:3],byte2[7:2],byte1[7:3]
 - 4: byte1[7:3],byte0[7:2],byte2[7:3]
 - 5: byte0[7:3],byte1[7:2],byte2[7:3]

If it is converted to RGBA8888 format, the value of A is the same as the value filled in bit ALPHA of the register MISC.

Image rectangle crop
---------------
By setting the start and end positions of the line synchronization signal and the frame synchronization signal cropping by the high 16 bits and the low 16 bits of the registers HSYNC_CONTROL and VSYNC_CONTROL, the image in the rectangular window of the specified position and size can be cropped, and the image beyond the rectangular part can be cropped. Data will be discarded. The start and end of the line synchronization signal are set to the pixel serial number, the start and end of the frame synchronization signal are set to the line number, and the cropped image contains the start point but not the end point.

Frame rounding function
---------------
A frame period n can be set through the register FRAME_PERIOD, the value range of n is 0~31, and the corresponding actual value is n+1, and then the register FRAME_VLD is used to set which frames of images are retained in a frame period. Write 1 in the corresponding bit position if you need to keep it, and write 0 in the corresponding bit position if you need to discard it. For example, if n is set to 5 and the value of FRAME_VLD is set to 0x13, in every 6 frames of images, the 1st, 2nd, and 5th frames will be written into the memory, and the 3rd, 4th, and 6th frames will be discarded. The cycle is performed with 6 frames of images as a cycle.

Line Frame Sync Signal Integrity Detection
-------------------------
The line synchronization signal comparison value and the frame synchronization signal comparison value can be set respectively through the lower 16 bits and the upper 16 bits of the register FRAME_SIZE_CONTROL, and the integrity of the signal can be detected. The line sync signal sets the total number of pixels in each row, and the frame sync signal sets the total number of lines. When the count value of the line or frame synchronization signal of a frame image is not equal to the comparison value, a corresponding interrupt will be generated.

Cache image information
-------------
The module contains 4 groups of FIFO to record the image address and image ID. Whenever this module completely writes a frame to the memory, it will record the start address and image ID of the frame image in this FIFO, but it should be noted that when the memory is insufficient, or the 4 sets of FIFO are full. In this case, the module will automatically discard the information of the next image. In the part where the image information is taken out, the oldest image information can be emptied by the pop operation. At this time, the FIFO will automatically advance to ensure the timing of the image information in the FIFO, as shown in the figure below:

.. figure:: ../../picture/CamFrameFIFO.svg
   :align: center

   FIFO framework

Support a variety of interrupt information (can be configured independently of the switch)
-------------------------------------
- Normal interrupt
  * a count value n can be set, and an interrupt will be issued every time n images are written

- Memory Interrupt
  * When the remaining memory space is less than one frame size, and the used memory is overwritten, an interrupt is issued, as shown in the following figure:

.. figure:: ../../picture/CamMem.svg
   :align: center

   Memory

- Frame interrupt
  * when there are more than 4 groups of unprocessed images and no more image information can be stored, an interrupt is issued

- FIFO interrupt
  * when the bus is too late to write to the memory, causing the FIFO to overflow, an interrupt is issued

- Hsync interrupt
  * when the number of pixels of a line in a frame of image is not equal to the set value (the line sync signal integrity test fails), an interrupt is issued

- Vsync interrupt
  * when the total number of lines in a frame of image is not equal to the set value (frame sync signal integrity check fails), an interrupt is issued

.. only:: html

   .. include:: dvp2axi_register.rst

.. raw:: latex

   \input{../../en/content/dvp2axi}