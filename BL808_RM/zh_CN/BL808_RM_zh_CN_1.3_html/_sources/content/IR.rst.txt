===========
IR
===========

简介
=====
红外遥控（Infrared remote，简称IR）是一种无线、非接触式控制技术，具有抗干扰能力强、信息传输可靠、功耗低、成本低等优点。红外遥控的发射电路是采用红外发光二极管来发出经过调制的红外光波；接收电路由红外接收二极管、三极管或硅光电池组成，它们将红外发射器发射的红外光转换为相应的电信号，再送至后置放大器。

主要特征
=========
 - 支持以固定协议NEC、RC-5接收数据
 - 支持以脉冲宽度计数方式接收任意格式数据
 - 强大的红外波形编辑能力，可发出符合各种协议的波形
 - 多达15个档位的功率设定，以适应不同的功耗要求
 - 接收最多支持64-bit数据位
 - 发送在非自由模式下最多支持128-bit数据位，自由模式下可连续发送任意长度数据
 - 4*4字节的发送FIFO，64*2字节的接收FIFO
 - 自由模式下发送FIFO宽度可调，支持8/16/24/32-bit
 - 载波频率与占空比可编程
 - 最高工作频率为32MHz
 - 发送支持DMA模式
 - 发送和接收结束中断

功能描述
===========
固定协议接收
-------------
IR接收支持两种固定的协议，分别为NEC协议和RC-5协议。

- NEC协议

NEC协议的逻辑1与逻辑0波形如下图所示：

.. figure:: ../../picture/IRNecLogical.svg
   :align: center

   NEC逻辑波形

逻辑1周期为2.25ms，脉冲时间560us；逻辑0周期为1.12ms，脉冲时间560us。
NEC协议的具体格式如下图所示：

.. figure:: ../../picture/IRNec.svg
   :align: center

   NEC协议波形

头脉冲是9ms的载波脉冲和4.5ms的低电平，之后是8-bit的地址码及其反码，然后是8-bit的命令码及其反码，尾脉冲是560us载波与560us低电平。

- RC-5协议

RC-5协议的逻辑1与逻辑0波形如下图所示：

.. figure:: ../../picture/IRRc5Logical.svg
   :align: center

   RC5逻辑波形

逻辑1周期为1.778ms，先是889us的低电平后是889us的载波；逻辑0与逻辑1波形相反。
RC-5协议的具体格式如下图所示：

.. figure:: ../../picture/IRRc5.svg
   :align: center

   RC5协议波形

前两位为开始位，固定为逻辑1，第三位是翻转位，当一个键值发出然后再按下时该位会取反。之后5位是地址码与6位命令码。
需要注意的是，常见的红外一体接收头为了提高接收灵敏度，接收到高电平后输出的是低电平，所以在使用IR接收功能时要将接收翻转功能打开。

脉冲宽度接收
-------------
对于NEC、RC-5协议以外的其他任意格式的数据，IR会以其内部工作时钟去依次计数每个高或者低电平的持续时间，然后将数据存入到深度为64，宽度为2字节的接收FIFO之中。

普通发送模式
-------------
用户可根据具体协议分别对头脉冲、尾脉冲、逻辑0和逻辑1脉冲进行相应的配置。在设置时需要计算出所使用的协议内各种不同宽度脉冲的公共脉冲宽度单位，即最大公约数，填入寄存器IRTX_PULSE_WIDTH的低12位，各脉冲将其所对应的倍数填入寄存器IRTX_PW中。
然后将要发送的逻辑值填入深度为4，宽度为4字节的发送FIFO之中。

脉冲宽度发送
-------------
对于不适用于普通发送模式的协议，IR提供了脉冲宽度发送的方式。先计算出所使用的协议内各种不同宽度脉冲的公共脉冲宽度单位，即最大公约数，填入寄存器IRTX_PULSE_WIDTH的低12位。然后将从第一个高电平开始到最后一个电平为止的各个电平宽度所对应的倍数(每个倍数占8-bit)每四个组合成一个32-bit数，填入TX FIFO中。

载波调制
-------------
通过设置寄存器IRTX_PULSE_WIDTH的高16位可以产生不同频率和占空比的载波，该寄存器的<TXMPH1W>位设置的是载波相位1的宽度，<TXMPH0W>位设置的是载波相位0的宽度。

自由模式
-------------
自由模式下不限制发送的数据总长度，当TX FIFO中有数据时就会发送，可配合DMA使用。另外，自由模式下的TX FIFO宽度可配置，支持8/16/24/32-bit。

DMA模式
-------------
IR TX支持DMA模式，使用该模式需要使能自由模式，并通过寄存器IRTX_FIFO_CONFIG_1中<TFITH>设置TX FIFO的阈值。
当该模式启用后，如果IRTX_FIFO_CONFIG_1中<TFICNT>大于<TFITH>，则会触发DMA TX请求，配置好DMA后，DMA在收到该请求时，会按照设定从内存中将数据搬运到TX FIFO。

IR中断
-------------
IR有单独的发送和接收结束中断，当一次发送动作结束时，会产生发送中断。当接收到一段数据时，它会等待电平持续长度达到设定的结束阈值时产生接收中断。
可以通过寄存器IRTX_INT_STS查询发送中断状态和清除中断，通过寄存器IRRX_INT_STS查询接收中断状态和清除中断。

.. only:: html

   .. include:: ir_register.rst

.. raw:: latex

   \input{../../zh_CN/content/ir}