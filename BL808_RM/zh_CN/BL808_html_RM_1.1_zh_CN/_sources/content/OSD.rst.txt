===========
OSD
===========

简介
=====
On-Screen Display(OSD)模块，是用于实现画面图层叠加的一种硬件模块。
OSD模块根据软件的设置，将一个指定的图形，通过一定的模式，叠加显示在底层图像之上。
OSD被广泛应用在电视、视频等领域，比如电视台的台标，播放时的进度显示等等。
OSD模块可以分为三个部分：OSD Blend、OSD Draw和OSD Probe。

主要特征
=========
- 支持码流OSD及显示OSD
- 码流及显示OSD模块都包含子模块：OSD Blend，OSD Draw
- OSD Blend特征如下

    + 支持4个Blend模块，大小模块各两个
    + 每个图层均支持一个全局透明度(global alpha)
    + 每个图层均支持一个全局颜色(global color)
    + 支持多种不同的颜色格式：ARGB,AYUV,RGB,YUV,palette模式等
    + 可以设置颜色元素排列的顺序，比如ARGB，BGRA等
    + 调色板(palette)模式支持1/2/4/8bpp(bits per pixel),实际颜色查找表元素可选yuv或RGB
    + 支持color keying，将在一个范围内(或不在此范围内，根据设置)的颜色替换为一个指定的颜色

- OSD Draw特征如下

    + 仅支持矩形图案的绘制，个数根据模块大小，可以是16或者32
    + 可以指定矩形的颜色(通过yuv的值指定)
    + 支持两种不同的绘制风格：填充或非填充
    + 对于非填充矩形，可以指定其边框宽度(必须是偶数)
    + 根据固定的优先级进行矩形的叠加显示
    + 不支持图形透明

- 码流OSD支持一个OSD Probe模块
- OSD Probe特征如下

    + 支持最大32组自定义坐标位置寄存器
    + 支持一个全局的亮度阈值
    + 两个输出结果寄存器，可以ping pong模式读取
    + 可对输出结果进行统计

- OSD模块的时钟依赖于对应的功能模块

功能描述
===========

OSD Blend
----------------
OSD Blend模块(以下简称Blend模块)是OSD模块的一部分，此模块用于在ISP输出的画面中进行一些高级的图层叠加。
一个图层是一个可以独立设置的，叠加在底层画面之上的一个2D区域。可以在此区域实现alpha blending, color keying等。
Blend模块根据实现的差异，分为大、小模块。区别在于，大的模块可以操作4个独立的图层，而小的模块只有2个独立图层。
同一个Blend模块的不同图层有固定的优先级，不同Blend模块之间的优先级可以设置，这取决于他们在pipeline上的位置。
图层的内容需要放置在内存中，由Blend模块进行读取并进行叠加操作。
Blend模块位于ISP的后方，与scaler模块的位置可以编程设置，这会对坐标位置的设置产生影响。

Blend模块用于在ISP的输出画面上的指定矩形区域进行画面的叠加显示，最直接的应用就是时间、位置等传统OSD信息显示。
结合Probe模块及Blend模块的透明功能，可以实现OSD字符显示的自动反白，背景透明的功能。
通过color keying的功能，可以实现简单的画面去背景的效果，比如用来显示一个非矩形的Logo等。
通过指定范围的color keying，可以实现渐变色进度条的自动更新显示。
为节省内存消耗及带宽消耗，对于简单的显示，可以使用调试板模式，甚至直接使用全局颜色及透明度。

时钟
***********
Blend模块依赖于ISP的时钟。

设置流程
***********

- 确认模块有工作时钟(ISP开启)
- 设计需要显示内容的位置参数：x/y轴尺寸及起始位置
- 根据需要显示的内容选择适合的颜色模式，对于简单、面积小的显示推荐选择调色板模式
- 在内存中，准备好显示需要用到的数据
- 编程Blend模块读取数据的位置，长度，以及读取数据的时机
- 设置颜色格式等相关的寄存器，如果是调色板模式，还需要加载相应的调色板数据
- 如果使用了keying模式，需要设置keying的范围，模式，以及替换的颜色
- 使能Blend模块的对应图层

OSD Draw
----------------
OSD Draw模块(以下简称Draw模块)是OSD模块的一部分。此模块用于在ISP输出的画面之上叠加矩形(框)。
Draw模块位于ISP的后方，与scaler模块的位置可以交换。
Draw模块分为大、小两种功能实现。小的模块可支持画16个矩形(框)，而大的模块支持32个。
大的模块可以看作是两个小模块组合而成。

Draw模块在ISP的输出中根据指定的坐标及设置的风格(填充/非填充)、颜色、边框宽度，进行矩形的绘制。
如果有不同的矩形绘制在同一位置，则根据一个固定的优先级(图层编号)进行叠加。

时钟
***********
Draw模块依赖于ISP的时钟。

设置流程
***********

- 确认模块有工作时钟(ISP开启)
- 设置矩形的坐标(x/y任意方向均需满足起始坐标设置为偶数，结束坐标设置为奇数)
- 设置矩形的颜色(yuv)，如果是非填充矩形，还需要设置线框的宽度
- 在模块控制寄存器中置位对应的矩形编号所对应的bit

OSD Probe
----------------
OSD Probe模块(以下简称Probe模块)是OSD模块的一部分。此模块用于对ISP输出中的部分位置进行亮度对比。
Probe模块位于ISP的后方，没有经过scaler模块。因此当后级画面经过了scaler，那么相应的坐标需要软件进行调整。

Probe模块从ISP的输出中获取指定位置处的像素的亮度值，并与给定的阈值进行比较。
如果该位置的亮度值大于或等于亮度阈值，则将对应像素点位置的比较输出置1。此功能可用于根据背景进行OSD的自动反白显示。

时钟
***********
Probe模块依赖于ISP的时钟。

设置流程
***********

- 确认模块有工作时钟(ISP开启)
- 设置亮度阈值
- 根据项目需要，设置0 ~ 31这32组位置寄存器，编程入采样点的x、y轴坐标
- 此模块将根据设置进行比较并更新相关的结果寄存器
- 通过控制器寄存器可以获取检测结果数量及当前使用的结果寄存器
- 从结果寄存器可以获取模块输出，根据每个bit的值就可以获取对应坐标的亮度比较结果
