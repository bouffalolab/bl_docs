===========
MJPEG
===========

简介
=====
MJPEG(Motion Joint Photographic Experts Group)是一种视频编码格式，可精确到帧编辑和多层图像处理，把运动的视频序列作为连续的静止图像来处理，这种压缩方式单独完整地压缩每一帧。通过对YCbCr格式的原始数据进行压缩，可以大幅降低一帧图像所占用的内存空间。

主要特征
=========
 - 可配置的输入格式，包括：
 
  * YCbCr4:2:2平面或打包模式
  * YCbCr4:2:0平面模式
  * YCbCr4:0:0
  
 - 可配置的输入数据Y、Cb、Cr排列顺序
 - 量化系数表可自由配置
 - 支持软件模式和连动模式
 - 支持swap模式
 - 支持kick模式
 - 可预留jpg头部空间和自动添加jpg尾
 - 连续缓存多达4组图片信息
 - 多种应用中断，有利于弹性使用与出错提示

功能描述
===========
输入配置
-----------
通过寄存器MJPEG_CONTROL_1的位<REG_YUV_MODE>可以选择输入数据的YCbCr格式，包括YCbCr4:2:2平面或打包模式，YCbCr4:2:0平面模式和YCbCr4:0:0灰度图。当选择YCbCr4:2:2打包模式时，通过寄存器MJPEG_HEADER_BYTE的高8位可以配置Y、Cb、Cr的排列顺序。在选择其他模式时，可以通过寄存器MJPEG_CONTROL_1的位<REG_ORDER_U_EVEN>设定Cb和Cr的顺序。详细的配置如下图所示。

.. figure:: ../../picture/MJPEGYUYVInterleaveOrderConfiguration.svg
   :align: center

量化系数表
-----------
量化系数表可由用户自由配置，<reg_q_0_00>到<reg_q_0_3F>表示灰度信息Y分量的量化表，<reg_q_1_00>到<reg_q_1_3F>表示色度信息Cb和Cr的量化表。量化表按照从左上角向下排列的顺序，第一列结束后紧跟第二列，即reg_q_0_00代表Y分量第一行第一列的量化数值，reg_q_0_01代表Y分量第二行第一列的量化数值，reg_q_0_07代表Y分量第八行第一列的量化数值，reg_q_0_08代表Y分量第一行第二列的量化数值，依次类推。

软件模式和连动模式
--------------------
将MJPEG_CONTROL_2寄存器的位<REG_MJPEG_SW_MODE>置1时即使能软件模式，在此模式下MJPEG会从内存中读取指定帧数的原始图片数据进行压缩，此模式下需要预先将图片数据准备好。

将MJPEG_CONTROL_2寄存器的位<REG_MJPEG_SW_MODE>清0时即使能连动模式，在此模式下MJPEG会将CAM模块的输出作为其输入进行处理，MJPEG是以8*8的数据块为一个单元进行处理的，当CAM向内存中写完8行数据后，MJPEG就会开始工作，MJPEG处理完的内存空间会释放给CAM重新使用，这样CAM无需一整张图片的内存空间即可完成与MJPEG的连动。

swap模式
-----------
使用swap模式时，MJPEG存储空间会被平均分成两块，当MJPEG写完其中一块时会产生一个中断通知软件将数据读走，而它会将数据写入另一块中。来回交替使用，从而用不足一帧图片的存储空间进行数据处理。

kick模式
-----------
将MJPEG_CONTROL_2寄存器的位<REG_SW_KICK_MODE>置1时即使能kick模式，在此模式下每次向MJPEG_CONTROL_2寄存器的位<REG_SW_KICK>写1即可启动一次压缩，压缩行数由MJPEG_YUV_MEM_SW寄存器的位<REG_SW_KICK_HBLK>确定。需要注意的是kick模式只能在软件模式下使用，不能在连动模式下使用。

jpg功能
-----------
jpg功能会自动在每帧数据的开头留出一定字节数的空间并填零，该空间的大小由寄存器MJPEG_HEADER_BYTE的低12位进行设置。另外如果使能自动填充jpg尾的话还会在每帧数据的结尾补上两个字节数据，这两个字节的值为0xFFD9。



缓存图片信息
-------------
模块内部包含4组FIFO记录图片地址、图片大小和量化系数。每当此模块完整写入一帧到内存，便会将此帧图片的起始地址、图片大小和量化系数纪录于此FIFO中，但要注意的是当发生内存剩余不足，或是4组FIFO满存的状况时，模块会自动丢掉接下来图片的讯息，在图片信息取出的部分，可通过APB接口做pop的动作，将最旧的图片信息空出，此时FIFO会自动推进，保证FIFO内部图片信息的时序。

支持多种中断信息(可独立开关配置)
-------------------------------------
A、	Normal 中断 – 可设定固定写入几张图片后发出中断

B、	Camera 中断 – MJPEG处理的速度跟不上CAM模块写入的速度导致CAM溢出时，发出中断

C、	Memory 中断 – 当内存被复写时，发出中断

D、	Frame 中断 – 当未处理图片超过4组时，发出中断

E、	Swap 中断 - 当swap模式下一个内存块被写满时，发出中断
