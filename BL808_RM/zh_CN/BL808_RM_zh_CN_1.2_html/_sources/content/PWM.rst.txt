===========
PWM
===========

简介
=====
脉冲宽度调制（Pulse width modulation，简称PWM）是一种利用微处理器的数字信号对模拟电路进行控制的一种非常有效的技术，广泛应用在从测量、通信到功率控制与变换的许多领域中。

主要特征
=========

- 支持2组PWM信号生成，每组包含4通道PWM信号输出，每通道可以设置为2路互补PWM

- 三种时钟源可选择（总线时钟<bclk>、晶振时钟<xtal_ck>、慢速时钟<32k>），搭配16-bit时钟分频器

- 每组PWM都可以独立设置为不同的周期

- 每通道PWM都有双门限值设定，可以设定不同的占空比和相位，增加脉冲弹性

- 每通道PWM都有独立的死区时间设定

- 每路PWM输出引脚都可以设定不同的有效电平

- 每路PWM都有独立的连接开关用来选择是否与内部计数器相连，并可设定不连接时的默认输出电平

- 软件刹车和外部刹车信号可以将PWM输出电平置于预先设定的状态

- 多达9种可用于触发ADC转换的触发源

- 如下事件发生时可产生中断：计数器溢出、门限值比较匹配、刹车信号产生、PWM周期数达到设定值

功能描述
===========
时钟与分频器
-------------
每个PWM计数器时钟来源都有三种选择，来源如下:

A. bclk - 芯片的总线时钟

B. XTAL - 外部晶振时钟

C. f32k - 系统RTC时钟

每个计数器都有各自的16-bit分频器，可通过APB将选择到的时钟进行分频，PWM计数器将以分频后的时钟作为计数周期单位，每经过一个计数周期进行数一的动作。

有效电平
---------
不同的应用场景所需要的有效电平状态是不一样的，一部分是低电平有效一部分是高电平有效，每路PWM输出的有效电平可独立设定。

当pwm_mcx_config1寄存器中的位<pwm_chy_ppl>设置为1时表示pwmx（x=0,1）的通道y（y=0,1,2,3）的正向通道被设置成高电平有效，即PWM模块输出逻辑1时其对应的引脚输出高电平，输出逻辑0时其对应的引脚输出低电平。如果<pwm_chy_ppl>设置为0则表示低电平有效，即PWM模块输出逻辑1时其对应的引脚输出低电平，输出逻辑0时其对应的引脚输出高电平。互补通道的设置位为<pwm_chy_npl>，其设置规则与正向通道相同。

脉冲产生原理
-------------
当pwm_mcx_config1寄存器中的位<pwm_chy_pen>设置为0时表示pwmx（x=0,1）的通道y（y=0,1,2,3）的正向通道输出被设置为一个确定的逻辑状态，此时状态由位<pwm_chy_psi>确定，当<pwm_chy_psi>为0时对应的正向通道引脚输出逻辑0，当<pwm_chy_psi>为1时对应的正向通道引脚输出逻辑1，实际输出电平需要和<pwm_chy_ppl>共同确定。互补通道的设置位为<pwm_chy_nen>，其设置规则与正向通道相同。

当pwm_mcx_config1寄存器中的位<pwm_chy_pen>（<pwm_chy_nen>）设置为1时表示pwmx（x=0,1）的通道y（y=0,1,2,3）的正向（互补）通道输出由内部计数器与两个阈值的比较结果确定，当计数器的值在两个阈值中间时，正向通道输出逻辑1，互补通道输出逻辑0，当计数器的值在两个阈值之外时，正向通道输出逻辑0，互补通道输出逻辑1。具体的波形如下图所示。

.. figure:: ../../picture/PWMWave.svg
   :align: center

   PWM在不同配置下的波形图

刹车
-----
当使用刹车功能且刹车信号产生时，PWM输出的电平都会被修改为预设定的状态，预设定状态由pwm_mcx_config1（x=0,1）寄存器中的位<pwm_chy_pbs>、<pwm_chy_nbs>（y=0,1,2,3）设定，当该位设置为1时，刹车信号产生后该路PWM输出逻辑1，当该位设置为0时，刹车信号产生后该路PWM输出逻辑0。

刹车信号包括外部刹车和软件刹车两种。当pwm_mcx_config0（x=0,1）的位<pwm_sw_break_en>为1时即产生内部刹车信号，该位为0时即退出刹车状态，PWM恢复之前的运行方式。当位<pwm_ext_break_en>为1时即使能外部刹车功能，如果此时外部刹车引脚状态与<pwm_ext_break_pl>设置的值相匹配，则产生刹车信号，如果刹车引脚状态变为与<pwm_ext_break_pl>设置的值相反则PWM退出刹车状态。需要注意的是只有PWM0有外部刹车功能，PWM1不具备外部刹车的特性。

如果使能了刹车中断，则在外部刹车信号产生时，会触发中断。软件刹车不会触发中断。

死区
------
PWM每个通道都可以独立设置不同的死区时间，当死区设定值不为0时，PWM的正向通道在与阈值1匹配时会延迟产生跳变的电平，在阈值2匹配时立即改变电平状态。PWM的互补通道在与阈值1匹配时会立即改变电平状态，在阈值2匹配时会延迟产生跳变的电平。死区长度由pwm_mcx_dead_time寄存器设置。


周期与占空比计算
-----------------
PWM的周期由两部分决定，一个是时钟分频系数，一个是时钟持续周期。时钟分频系数由寄存器PWMx_CLK_DIV[15:0](x为0~1)进行设置，用于对PWM的源时钟进行分频。时钟持续周期由寄存器PWMx_PERIOD[15:0](x为0~1)进行设置，用于设置PWM的一个周期由多少个分频后的时钟周期组成。即PWM的周期=PWM源时钟/PWMx_CLK_DIV[15:0]/PWMx_PERIOD[15:0]。

PWM中断
-------------
对于每一组PWM，可以由pwm_mcx_period寄存器的高16位设置周期计数值，当PWM的周期数达到这个计数值时，将产生PWM中断。

当PWM计数值达到周期数或计数值与阈值匹配都将产生PWM中断。

有外部刹车信号产生时会产生PWM中断。

ADC联动
----------
当计数器与门限值发生匹配或者计数值达到周期数时都可以产生内部触发ADC启动转换的信号，需要注意的是只有PWM0可以触发ADC启动转换，PWM1不具备该特性。具体的触发源由pwm_mcx_config0寄存器的位<pwm_adc_trg_src>设置。这种特性在定时采样的应用场景中较为常用。以下举例说明。

应用场景：在BLDC的应用中，有这样一种应用需求，在用PWM控制电机的转速的同时，还需要检测流过线圈的电流。在一个PWM周期内，PWM控制功率器件导通后，经过一段特定的时间电流达到稳定，此时需要采样电流值，这意味着触发ADC转换的时刻点与PWM之间有严格的相位差。比如PWM的通道0用于驱动电机的其中一相，需要产生10KHz占空比为20%的方波，并且需要在方波高电平的中间时刻点执行ADC采样，则该PWM周期为100us，当时钟源为1MHz时，周期计数值为100，可以将通道1的两个阈值分别设置为0和20，此时计数器在0~20之间时，PWM输出高电平，否则输出低电平。将通道2的阈值L设置为10，且将pwm_mc0_config0寄存器中的pwm_adc_trg_src设置为4即pwm_ch2l_int可以触发ADC转换，则计数器数到10时即通道1产生的高电平中间时刻会启动ADC开始采样转换，这样就可以保证每次采样都满足精确的时间要求，且不需要CPU干预，从而提高了性能。

.. only:: html

   .. include:: pwm_register.rst

.. raw:: latex

   \input{../../zh_CN/content/pwm}