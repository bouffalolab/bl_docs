=========
LowPower
=========

概述
=====
低功耗是物联网应用的一项重要指标。芯片的处理器包含3种功耗模式，包含工作模式、
空闲省电模式和休眠模式，可以根据当前应用场景选择合适的功耗模式，降低芯片功耗延长电池寿命。

.. figure:: ../../picture/LPPwrSt.png
   :align: center

   低功耗模式

主要特征
=========

- 时钟控制:GLB中对各外设的时钟控制，小范围的省电，响应速度较快
- 睡眠控制 (PDS) : 包含PDS1/2/3/7这4个等级，大范围省电，响应速度中等
- 深度睡眠控制 (HBN) : 包含HBN0/1/2/3这4个等级，全局省电，响应时间长


功能描述
==========

电源域
-----------
BL808 芯片中有 7 个电源域，每个电源域的主要功能如下所示：

- PD_AON_RTC

   * 保留 RC32K/XTAL32K 控制寄存器
   * RTC Counter 时钟源选择功能
   * RTC 可以用于唤醒，也可用于 LED 闪烁

- PD_AON

   * HBN状态机控制电源/隔离/复位/时钟
   * 保持内部电压输出选择
   * AON_PIN（GPIO9/10/11/12/13/40/41） 引脚唤醒控制
   * HBN_OUT0_PIR（Acomp0/Acomp1/bor/pir）唤醒屏蔽和使能寄存器、中断状态寄存器
   * BOR（Brown Out Reset）设置功能

- PD_AON_HBNCORE

   * 部分电源控制寄存器
   * 4KB的HBN_RAM，用于在进入PDS/HBN模式前保存程序数据，进入PDS/HBN后数据不会消失
   * PIR数字控制，PIR是热释电红外传感器，HBN区域内的一个外设，可以用作HBN唤醒源
   * AON_PIN 控制和 在 HBN 或 PDS 模式下 IO 保持功能
   * Acomp0 、Acomp1 配置 ， GPADC 时钟源选择和配置

- PD_CORE

   * HBN状态机控制电源/隔离/复位/时钟
   * 64KB保留RAM
   * WIFI/BLE计时器控制
   * 160KB WRAM/EM

- PD_CORE_MISC_DIG

   * M0 CPU及其外设
   * 芯片全局寄存器

- PD_USB

   * USB 数字控制器
- PD_MM

   * D0 CPU及其外设、PSRAM
   * Codec
   * VRAM 32~96KB
   * BLAI

每个电源域都由 9 个不同的电源模式控制，具体的控制方式如下表所示：

.. table:: 电源模式
    :widths: 5, 10, 13,10,15,10,17,10,10
    :width: 100%
    :align: center

    +--------+------------+------------+--------------+----------------+------------+------------------+------------+------------+
    |        |            | Power Domain                                                                                         |
    +        +            +------------+--------------+----------------+------------+------------------+------------+------------+
    | NO.    | Scenario   | PD_AON_RTC |   PD_AON     | PD_AON_HBNCORE | PD_CORE    | PD_CORE_MISC_DIG | PD_USB     | PD_MM      |
    +========+============+============+==============+================+============+==================+============+============+
    | 1      | Normal     |    ON      |     ON       |     ON         |     ON     |     ON           | ON         |     ON     |
    +--------+------------+------------+--------------+----------------+------------+------------------+------------+------------+
    | 2      | PDS1       |    ON      |     ON       |     ON         |    ON      |     ON           | ON         |     OFF    |
    +--------+------------+------------+--------------+----------------+------------+------------------+------------+------------+
    | 3      | PDS2       |    ON      |     ON       |     ON         |    ON      |     ON           | OFF        |     ON     |
    +--------+------------+------------+--------------+----------------+------------+------------------+------------+------------+
    | 4      | PDS3       |    ON      |     ON       |     ON         |    ON      |     ON           | OFF        |     OFF    |
    +--------+------------+------------+--------------+----------------+------------+------------------+------------+------------+
    | 5      | PDS7       |    ON      |     ON       |     ON         |    ON      |     OFF          | OFF        |     OFF    |
    +--------+------------+------------+--------------+----------------+------------+------------------+------------+------------+
    | 6      | HBN0       |    ON      |     ON       |     ON         |    OFF     |     OFF          | OFF        |     OFF    |
    +--------+------------+------------+--------------+----------------+------------+------------------+------------+------------+
    | 7      | HBN1       |    ON      |     ON       |    OFF         |    OFF     |     OFF          | OFF        |     OFF    |
    +--------+------------+------------+--------------+----------------+------------+------------------+------------+------------+
    | 8      | HBN2       |    ON      |     OFF      |     OFF        |    OFF     |     OFF          | OFF        |     OFF    |
    +--------+------------+------------+--------------+----------------+------------+------------------+------------+------------+
    | 9      | HBN3       |    OFF     |     OFF      |     OFF        |    OFF     |     OFF          | OFF        |     OFF    |
    +--------+------------+------------+--------------+----------------+------------+------------------+------------+------------+

注：

- 进入 HBN2 模式需要芯片先进入 HBN1 后，再断开 VDDIO2 电。
- 在 HBN2 模式下只保留 RTC_Timer ，但是不做唤醒；退出 HBN2 模式只需重新供 VDDIO2。
- VDD33_RTC/ VDDIO2(AON) 共用 pin 的封装 (QFN88 Type2, QFN68) 没有 HBN2 模式。
- 进入 HBN3 模式需要断电 pu_chip ，HBN3 模式将关闭大部分电源，仅 RTC 电源可以通过 rtc_pu_chip_sel 选择是否关掉 RTC 电源。
rtc_pu_chip_sel 为 1，RTC 电源一直保持； rtc_pu_chip_sel 为 0，RTC 电源被 pu_chip 控制。rtc_pu_chip_sel 值在封装时决定。


唤醒源
------------
芯片内部支持多种唤醒源，可从不同电源模式中唤醒。

PDS1/2/3可以通过以下方式唤醒：

- HBN 唤醒源
- 所有 GPIO 唤醒
- 红外接收器
- BLE 唤醒事件
- WIFI 唤醒事件
- PDS 计时器

其余电源模式的唤醒源如下表所示：

.. table:: 唤醒源
    :widths: 30, 70
    :width: 100%
    :align: center

    +--------------+-----------------------------------------------------------+
    |电源模式      |唤醒源                                                     |
    +==============+===========================================================+
    |PDS7          |PDS计时器/PSD_PIN/RTC/AON_PIN/BOR/Pir/Acomp0/Acomp1        |
    +--------------+-----------------------------------------------------------+
    |HBN0          |RTC/AON_PIN/BOR/Pir/Acomp0/Acomp1                          |
    +--------------+-----------------------------------------------------------+
    |HBN1          |RTC/AON_PIN                                                |
    +--------------+-----------------------------------------------------------+
    |HBN2          |重新供 VDDIO2                                              |
    +--------------+-----------------------------------------------------------+
    |HBN3          |重新供 pu_chip                                             |
    +--------------+-----------------------------------------------------------+


功耗模式
------------
**工作模式**

芯片提供处理器与外设独立的时钟控制，在 GLB 和时钟的章节介绍对各模块的时钟控制，软件可以根据当前应用场景，对于不需要使用的处理器或外设进行时钟控制。
时钟控制的反应是实时的，在此工作模式下，不需要担心响应时间。

**掉电睡眠模式(PDS)**

掉电模式相较于工作模式功耗较低。进入PDS模式后，将 RTC(Real Time Clock) 之外的时钟进行管控，会切换为内部低速时钟，并将外部晶振与PLL
关闭达到更加省电的状态，因此进入与离开此低功耗模式会有时间延迟。当进入掉电睡眠模式时，OCRAM 区域的数据可以自动进入 retention 状态而保留
下来，当唤醒后可以自行退出 retention 状态。

1. 进入空闲省电模式

软件可通过 PDS 配置让此模块进入掉电模式，等待处理，进入等待中断模式 (WFI) 后，PDS 模
块会触发时钟控制模块进入gate clock操作，并通知模拟电路关闭PLL以及外部晶振

2. 离开空闲省电模式

离开空闲省电模式的方式有两种，第一是空闲中间有特定的中断或事件打断空闲状态，第二是软件设定PDS_TIM
的时间达到，两者均会触发 PDS 模块离开掉电模式。注意：因为打开晶振需要
约 1ms 的时间，PDS 提供软件提前打开晶振的方式，这个做法可以加速 PDS 醒来。
当 PDS 模块准备醒来时，此模块会通过中断通知处理器离开等待中断模式 (WFI)。

**休眠模式(HBN)**

休眠模式在保留 AON(Always On) 电源的状态下，将大部分的芯片逻辑进行断电 (Vcore)，直到收到外
部事件才会将内部电路唤醒的。
在休眠模式下可以达到极致的省电状态，但相对于前两者需要的响应时间也最长，适合长时间不需要工作
的状态下，可以进入此状态，延长电池寿命。
休眠时期会将大部分的电路断电，对应的寄存器值和内存的数据也会消失。因此 HBN 内部留有 4KB HBN_RAM，这个
内存在 HBN0 模式时不会断电，软件有需要保存的资料或状态可以在进入休眠前拷贝到这个内存。从休眠
恢复时，可以直接从 RAM 中存取数据，通常可以用作状态的纪录或是数据快速恢复。

IO 保持
------------

IO 保持可以分为 AON_IO 保持和 PDS_IO 保持。
PDS0/1/2/3 模式下，由于 芯片 MISC domain 仍有电，所以 GPIO 可被 glb 寄存器控制。
当 glb 寄存器被断电之后，可由 AON_CTRL 和 PDS 简单控制 AON_IO 和 PDS_IO 的 IE/PD/PU。

**AON_IO**

AON_IO 指 GPIO9/10/11/12/13/14/15/40/41 。GPIO40/41 默认作为 XTAL32K 输入和输出使用 (要改成其它 pinmux 用途才可以作为 AON_IO 使用）
当 GPIO40/41 的 IE/OE 都被设为 0 时，GPIO40/41 复用模拟功能  XTAL32K_IN\XTAL32K_OUT ; 相反，当 GPIO40/41 的 IE/OE 不都为 0 时，GPIO40/41 用作普通 IO 功能。
例如，GPIO40 作为普通 IO 功能具体配置如下：reg_en_aon_ctrl_gpio[7] 和 reg_aon_pad_oe[7] 配为 0，reg_aon_pad_ie_smt[7] 配为 1。

1、硬件 IO 保持
HBN 可以控制 AON_IO 的 IE/PD/PU/OE/O ,从而实现 IO 保持。
reg_en_aon_ctrl_gpio 为 1 时，AON_IO 的上拉使能由 reg_aon_gpio_pu 控制，下拉使能由 reg_aon_gpio_pd 控制，OE 由 reg_aon_gpio_oe 控制，
AON PAD O 分别由 aon_led_out[0]、[1]、[2] 控制。而 IE/SMT ，无论 reg_en_aon_ctrl_gpio 的值是 0 还是 1，都可以由 reg_aon_gpio_ie_smt 控制。
例如， reg_en_aon_ctrl_gpio 为 0，即使 reg_aon_pad_pu 为 1，也不能实现上拉，但是 reg_aon_gpio_ie_smt 为 1，可以实现 IE 功能。

2、软件 IO 保持
将 reg_aon_gpio_iso_mode 配置为 1 后, 进入 HBN 模式时, AON PAD 可以保持 OE\O , PU\PD 不能保持；等到 HBN 唤醒后, AON PAD 状态仍会保持着，
需要把 reg_aon_gpio_iso_mode 请 0 后, 才会离开 IO 保持状态。
例如，GPIO40 在 HBN 模式下保持高电平，需要先将其配为 普通 IO 功能，然后用 glb 寄存器配置为输出高电平，最后将 reg_aon_gpio_iso_mode 配置为 1 后, 进入 HBN 模式。


**PDS_IO**

PDS_IO 指除 AON_IO 以外的其他 GPIO ，共 32 个 GPIO ，按 PAD 的物理位置分为 3 组：

- 左面 : GPIO0~8
- 右面 : GPIO16~23
- 上面 : GPIO24~39

1、硬件 IO 保持
PDS_IO 的 IE/PD/PU 可由 pds_gpio_i_set 寄存器控制，相同的组 GPIO 必须保持相同的电平。
例如， GPIO0 是配置为上拉，那么 GPIO8 也是配置为上拉的。

2、软件 IO 保持
当 cr_pds_gpio_iso_mode 为 1 时，进入 PDS7 模式后，如果 cr_pds_gpio_kee_en[0]、[1]、[2] 为 1 ，GPIO0~8、GPIO16~23、GPIO24~38分别进入 GPIO 保持状态，
等到 PDS7 唤醒后, PDS_IO 状态仍会保持着，需要把 cr_pds_gpio_iso_mode 请 0 后, 才会离开 IO 保持状态。
这种 IO 保持方式的优势是可以实现同一组 GPIO 保持不同的电平。

.. only:: html

   .. include:: HBN_register.rst

.. raw:: latex

   \input{../../zh_CN/content/HBN}